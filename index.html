<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zhodler 2026 Portfolio Dashboard</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Personal cryptocurrency portfolio tracker">
    <meta name="theme-color" content="#0ad5ec">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zhodler">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.0/dist/gridstack-extra.min.css" rel="stylesheet"/>
    <!-- Inter font - optimized for screens -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           TYPOGRAPHY SYSTEM
           Based on: Inter + IBM Plex Sans patterns
           Scale: 12px / 13px / 14px / 16px / 20px / 28px / 36px
           ============================================ */
        
        :root {
            /* Typography Scale */
            --font-family-primary: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
            
            /* Font Sizes - Optimized for 1080p+ readability */
            --text-xs: 12px;      /* Timestamps, micro labels (min readable) */
            --text-sm: 13px;      /* Table labels, metadata */
            --text-base: 14px;    /* Body text, table data */
            --text-md: 15px;      /* Primary body, descriptions */
            --text-lg: 17px;      /* Section headers, emphasis */
            --text-xl: 20px;      /* Widget titles, sub-headings */
            --text-2xl: 26px;     /* Page title */
            --text-3xl: 34px;     /* Large KPIs */
            --text-4xl: 42px;     /* Hero numbers */
            
            /* Line Heights */
            --leading-tight: 1.2;
            --leading-snug: 1.35;
            --leading-normal: 1.5;
            --leading-relaxed: 1.6;
            
            /* Letter Spacing */
            --tracking-tighter: -0.03em;
            --tracking-tight: -0.02em;
            --tracking-normal: -0.01em;
            --tracking-wide: 0.02em;
            --tracking-wider: 0.04em;
            
            /* Font Weights */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            
            /* Cyan theme (default) - Refined contrasts */
            --bg-primary: #0a1628;
            --bg-secondary: #0f1f35;
            --bg-tertiary: #142940;
            --bg-card: #152a45;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --text-muted: #475569;
            --accent-green: #22d3ee;
            --accent-red: #f87171;
            --accent-blue: #3b82f6;
            --accent-yellow: #fbbf24;
            --accent-purple: #a78bfa;
            --border-color: rgba(148, 163, 184, 0.15);
            --border-color-strong: rgba(148, 163, 184, 0.25);
        }
        
        /* Neon theme - Vaporwave aesthetic with refined typography contrast */
        .theme-neon {
            --bg-primary: #0a0a1f;
            --bg-secondary: #0f0f2a;
            --bg-tertiary: #151535;
            --bg-card: #1a1a40;
            --text-primary: #f8fafc;
            --text-secondary: #c4b5fd;
            --text-tertiary: #a78bfa;
            --text-muted: #7c3aed;
            --accent-green: #4ade80;
            --accent-red: #fb7185;
            --accent-blue: #38bdf8;
            --accent-yellow: #facc15;
            --accent-purple: #c084fc;
            --border-color: rgba(167, 139, 250, 0.15);
            --border-color-strong: rgba(167, 139, 250, 0.25);
        }
        
        /* Cyber theme - Terminal/hacker aesthetic */
        .theme-cyber {
            --bg-primary: #0c1419;
            --bg-secondary: #111d24;
            --bg-tertiary: #16262f;
            --bg-card: #1a2f3a;
            --text-primary: #e2e8f0;
            --text-secondary: #5eead4;
            --text-tertiary: #2dd4bf;
            --text-muted: #14b8a6;
            --accent-green: #34d399;
            --accent-red: #f87171;
            --accent-blue: #38bdf8;
            --accent-yellow: #fde047;
            --accent-purple: #a78bfa;
            --border-color: rgba(94, 234, 212, 0.12);
            --border-color-strong: rgba(94, 234, 212, 0.2);
        }

        /* ============================================
           BASE STYLES
           ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-primary);
            font-size: var(--text-base);
            font-weight: var(--font-normal);
            line-height: var(--leading-normal);
            letter-spacing: var(--tracking-normal);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }

        /* ============================================
           HEADER
           ============================================ */
        
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--accent-green);
            letter-spacing: var(--tracking-tight);
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ============================================
           BUTTONS & CONTROLS
           ============================================ */
        
        .btn {
            padding: 0.5rem 0.875rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-family-primary);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            line-height: var(--leading-tight);
            letter-spacing: var(--tracking-normal);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.03);
        }

        .btn:hover {
            background: var(--accent-blue);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: var(--accent-green);
            color: #0a1628;
            font-weight: var(--font-semibold);
        }

        .btn.locked {
            background: var(--accent-green);
            color: #0a1628;
        }
        
        .btn.locked:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        select {
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-family-primary);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.03);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        select:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .last-updated {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            font-weight: var(--font-medium);
        }

        /* ============================================
           GRID & WIDGETS
           ============================================ */
        
        .dashboard-container {
            padding: 6px;
        }

        .grid-stack {
            background: var(--bg-primary);
        }
        
        .grid-stack > .grid-stack-item {
            padding: 6px !important;
        }

        .grid-stack-item-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .grid-stack-item-content:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        /* ============================================
           WIDGET TYPOGRAPHY
           ============================================ */
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .widget-title {
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
        }

        .widget-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: auto;
            min-height: 0;
            height: 100%;
        }

        /* ============================================
           KPI VALUES - Financial Dashboard Style
           ============================================ */
        
        .kpi-value {
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            line-height: var(--leading-tight);
            letter-spacing: var(--tracking-tighter);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Responsive KPI scaling */
        .gs-h-2 .kpi-value { font-size: 28px; }
        .gs-h-3 .kpi-value { font-size: var(--text-3xl); }
        .gs-h-4 .kpi-value { font-size: var(--text-4xl); }

        .kpi-change {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            margin-top: 6px;
            font-variant-numeric: tabular-nums;
            letter-spacing: var(--tracking-normal);
        }

        .kpi-change.positive { color: var(--accent-green); }
        .kpi-change.negative { color: var(--accent-red); }
        .kpi-change.warning { color: var(--accent-yellow); }

        .kpi-label {
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            color: var(--text-tertiary);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: var(--tracking-wide);
        }

        /* ============================================
           PRIVACY FEATURE
           ============================================ */
        
        .privacy-mode .sensitive-data {
            filter: blur(10px);
            user-select: none;
            transition: filter 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .privacy-mode .sensitive-data:hover {
            filter: blur(0);
        }
        
        .privacy-toggle {
            cursor: pointer;
            padding: 0.375rem 0.625rem;
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            border-radius: 8px;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .privacy-toggle:hover {
            background: var(--accent-blue);
            color: #fff;
            transform: translateY(-1px);
        }
        
        .privacy-toggle.active {
            background: var(--accent-red);
            color: #fff;
        }

        /* ============================================
           CHARTS
           ============================================ */
        
        .chart-container {
            position: relative;
            width: 100%;
            flex: 1;
            min-height: 100px;
            height: 100%;
        }
        
        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* ============================================
           GOALS & PROGRESS
           ============================================ */
        
        .goal-item {
            margin-bottom: 12px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            font-size: var(--text-sm);
            margin-bottom: 6px;
        }

        .goal-name {
            color: var(--text-primary);
            font-weight: var(--font-medium);
        }

        .goal-percent {
            color: var(--accent-blue);
            font-weight: var(--font-semibold);
            font-variant-numeric: tabular-nums;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 100px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--chart-color-1, #22d3ee), var(--chart-color-2, #3b82f6));
            border-radius: 100px;
            transition: width 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--chart-color-4, #fbbf24), var(--chart-contrast, #f87171));
        }

        /* ============================================
           METRICS & DATA ROWS
           ============================================ */
        
        .loan-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: var(--text-sm);
            gap: 0.5rem;
        }

        .loan-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-weight: var(--font-normal);
        }

        .metric-value {
            font-weight: var(--font-semibold);
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        .metric-value.safe { color: var(--accent-green); }
        .metric-value.warning { color: var(--accent-yellow); }
        .metric-value.danger { color: var(--accent-red); }

        /* ============================================
           TABLES
           ============================================ */
        
        .data-table {
            width: 100%;
            font-size: var(--text-sm);
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 8px 10px;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border-color-strong);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wide);
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-variant-numeric: tabular-nums;
        }

        /* ============================================
           MODAL STYLES
           ============================================ */
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 24px 48px rgba(0,0,0,0.3), 0 12px 24px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }

        .modal h2 {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            margin-bottom: 20px;
            color: var(--accent-green);
            letter-spacing: var(--tracking-tight);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 10px;
            font-family: var(--font-family-primary);
            font-size: var(--text-md);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06), 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        /* Modal Tabs */
        .modal-tab {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-family: var(--font-family-primary);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .modal-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .modal-tab.active {
            background: var(--accent-blue);
            color: white;
        }
        
        .modal-tab-content {
            min-height: 200px;
        }

        /* ============================================
           LOADING & SPINNER
           ============================================ */
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-tertiary);
            font-size: var(--text-sm);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           RESPONSIVE STYLES
           ============================================ */
        
        /* Extra Large Screens (1440p+) */
        @media (min-width: 1600px) {
            :root {
                --text-xs: 13px;
                --text-sm: 14px;
                --text-base: 15px;
                --text-md: 16px;
                --text-lg: 18px;
                --text-xl: 22px;
                --text-2xl: 28px;
                --text-3xl: 38px;
                --text-4xl: 48px;
            }
            .grid-stack-item-content {
                padding: 22px;
            }
        }

        /* Large Screens (1080p - default) */
        @media (min-width: 1200px) and (max-width: 1599px) {
            .kpi-value {
                font-size: var(--text-3xl);
            }
            .widget-title {
                font-size: var(--text-sm);
            }
            .grid-stack-item-content {
                padding: 18px;
            }
        }

        /* Medium Screens (Laptops) */
        @media (max-width: 1199px) and (min-width: 769px) {
            :root {
                --text-xs: 12px;
                --text-sm: 13px;
                --text-base: 14px;
                --text-md: 15px;
                --text-lg: 16px;
                --text-xl: 19px;
                --text-2xl: 24px;
                --text-3xl: 30px;
                --text-4xl: 38px;
            }
            .grid-stack-item-content {
                padding: 16px;
            }
        }
        
        /* Tablets */
        @media (max-width: 768px) {
            :root {
                --text-xs: 12px;
                --text-sm: 13px;
                --text-base: 14px;
                --text-md: 14px;
                --text-lg: 15px;
                --text-xl: 17px;
                --text-2xl: 20px;
                --text-3xl: 26px;
                --text-4xl: 32px;
            }
            
            .header {
                padding: 12px 14px;
            }
            
            .header h1 {
                font-size: var(--text-md);
            }
            
            .header-controls {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .header-controls .btn,
            .header-controls select {
                padding: 8px 12px;
                font-size: var(--text-xs);
            }
            
            .last-updated {
                display: none;
            }
            
            .kpi-value {
                font-size: var(--text-3xl);
            }
            
            .kpi-change {
                font-size: var(--text-sm);
            }
            
            .kpi-label {
                font-size: var(--text-xs);
            }
            
            .widget-title {
                font-size: var(--text-xs);
            }
            
            .loan-metric {
                font-size: var(--text-sm);
                padding: 8px 0;
            }
            
            .goal-header {
                font-size: var(--text-sm);
            }
            
            .progress-bar {
                height: 5px;
            }

            .grid-stack {
                --gs-column-count: 6;
            }
            
            .grid-stack-item-content {
                padding: 14px;
                border-radius: 10px;
            }
            
            .widget-header {
                margin-bottom: 10px;
                padding-bottom: 8px;
            }
        }
        
        /* Mobile */
        @media (max-width: 480px) {
            :root {
                --text-xs: 11px;
                --text-sm: 12px;
                --text-base: 13px;
                --text-md: 14px;
                --text-lg: 15px;
                --text-xl: 16px;
                --text-2xl: 18px;
                --text-3xl: 22px;
                --text-4xl: 28px;
            }
            
            .header {
                padding: 10px 12px;
            }
            
            .header h1 {
                font-size: var(--text-base);
            }
            
            .header-controls .btn,
            .header-controls select {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .kpi-value {
                font-size: var(--text-3xl);
            }
            
            .loan-metric {
                flex-direction: column;
                gap: 4px;
                font-size: var(--text-sm);
            }
            
            .metric-value {
                text-align: left;
            }
            
            .grid-stack-item-content {
                padding: 12px;
            }
            
            .widget-header {
                margin-bottom: 8px;
                padding-bottom: 6px;
            }
        }

        /* Drag handle */
        .gs-item .drag-handle {
            cursor: move;
            color: var(--text-tertiary);
        }
        
        /* ============================================
           UTILITY CLASSES
           ============================================ */
        
        .font-mono {
            font-family: var(--font-family-mono);
        }
        
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }
        
        .text-xs { font-size: var(--text-xs); }
        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-md { font-size: var(--text-md); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }
        
        .font-medium { font-weight: var(--font-medium); }
        .font-semibold { font-weight: var(--font-semibold); }
        .font-bold { font-weight: var(--font-bold); }
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }
        .text-muted { color: var(--text-muted); }
        
        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }
        .text-blue { color: var(--accent-blue); }
        .text-yellow { color: var(--accent-yellow); }
        
        /* ============================================
           INFO TOOLTIP SYSTEM
           ============================================ */
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-tertiary);
            font-size: 10px;
            font-weight: 600;
            font-style: italic;
            font-family: Georgia, serif;
            cursor: pointer;
            margin-left: 4px;
            transition: all 0.2s ease;
            vertical-align: middle;
        }
        
        .info-icon:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            transform: scale(1.1);
        }
        
        .tooltip-popup {
            display: none;
            position: fixed;
            z-index: 10000;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 16px;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        .tooltip-popup.active {
            display: block;
            animation: tooltipFadeIn 0.2s ease;
        }
        
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tooltip-popup .tooltip-title {
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tooltip-popup .tooltip-content {
            color: var(--text-secondary);
        }
        
        .tooltip-popup .tooltip-close {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .tooltip-popup .tooltip-close:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üìä Zhodler 2026 Portfolio</h1>
        <div class="header-controls">
            <span class="last-updated" id="lastUpdated">Last updated: --</span>
            <button class="btn btn-primary" id="refreshBtn">üîÑ Refresh Data</button>
            <button class="privacy-toggle" id="privacyToggle" title="Toggle privacy mode">üîí Privacy</button>
            <select id="themeSelect">
                <option value="default">üåä Cyan</option>
                <option value="neon">üíú Neon</option>
                <option value="cyber">ü§ñ Cyber</option>
            </select>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <label for="accentColorPicker" style="font-size: 0.85rem; color: var(--text-secondary);">üé®</label>
                <input type="color" id="accentColorPicker" value="#0ad5ec" title="Chart accent color" style="width: 32px; height: 28px; border: none; border-radius: 4px; cursor: pointer; background: transparent;">
            </div>
            <button class="btn" id="lockLayoutBtn" title="Lock/Unlock Layout">üîì Unlocked</button>
            <button class="btn" id="settingsBtn">‚öôÔ∏è Settings</button>
            <button class="btn" id="resetLayoutBtn">‚Ü©Ô∏è Reset Layout</button>
        </div>
    </header>
    
    <div id="statusBar" style="padding: 12px 20px; background: #2980b9; color: white; text-align: center; font-size: 14px;">
        üîÑ Loading... (Your Google Sheet must be published: File ‚Üí Share ‚Üí Publish to web)
    </div>

    <!-- Tooltip Popup Container -->
    <div id="tooltipPopup" class="tooltip-popup">
        <button class="tooltip-close" onclick="hideTooltip()">&times;</button>
        <div class="tooltip-title" id="tooltipTitle"></div>
        <div class="tooltip-content" id="tooltipContent"></div>
    </div>

    <div class="dashboard-container">
        <div class="grid-stack" id="dashboard"></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
            <h2>‚öôÔ∏è Dashboard Settings</h2>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 0.25rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; flex-wrap: wrap;">
                <button class="modal-tab active" data-tab="data" onclick="switchModalTab('data')">üìä Data</button>
                <button class="modal-tab" data-tab="display" onclick="switchModalTab('display')">üé® Display</button>
                <button class="modal-tab" data-tab="peer" onclick="switchModalTab('peer')">üë• Peer</button>
                <button class="modal-tab" data-tab="monte" onclick="switchModalTab('monte')">üìà Monte Carlo</button>
                <button class="modal-tab" data-tab="sync" onclick="switchModalTab('sync')">üíæ Sync</button>
            </div>
            
            <!-- Data Source Tab -->
            <div id="modal-tab-data" class="modal-tab-content">
                <div class="form-group" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <label style="font-weight: 600; color: var(--accent-green);">üìä Google Sheets URL</label>
                    <input type="text" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/19FOCRgYHY94QN3Jf7NaeMpGsEbQUdu9bKboYvy4fVpk/edit">
                    <div style="margin-top: 0.75rem;">
                        <button class="btn" id="testConnectionBtn" style="width: 100%;">üîç Test Connection</button>
                    </div>
                    <div id="testResult" style="font-size: 0.8rem; margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; display: none;"></div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.75rem;">
                        <strong>‚ö†Ô∏è Important Setup:</strong><br>
                        1. Open your Google Sheet<br>
                        2. Go to <strong>File ‚Üí Share ‚Üí Publish to web</strong><br>
                        3. Select "Entire Document" and click <strong>Publish</strong><br>
                        4. Paste your sheet URL above (the regular edit URL is fine)<br><br>
                        <strong>üí° Data not updating?</strong> Google caches published sheets for ~5 minutes. 
                        To force immediate refresh: <em>File ‚Üí Share ‚Üí Publish to web ‚Üí Stop publishing</em>, 
                        then republish.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Auto-refresh interval</label>
                    <select id="refreshInterval">
                        <option value="0">Manual only</option>
                        <option value="60">Every 1 minute</option>
                        <option value="300">Every 5 minutes (recommended)</option>
                        <option value="900">Every 15 minutes</option>
                        <option value="1800">Every 30 minutes</option>
                    </select>
                    <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                        Note: Due to Google's ~5 min cache, refreshing more frequently won't show newer data.
                    </div>
                </div>
            </div>

            <!-- Display Tab -->
            <div id="modal-tab-display" class="modal-tab-content" style="display: none;">
                <div class="form-group">
                    <label>Chart Accent Color</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="color" id="settingsAccentColor" value="#0ad5ec" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                All chart colors are generated as shades of this color
                            </div>
                            <div id="palettePreview" style="display: flex; gap: 2px; margin-top: 0.5rem;"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Currency Display</label>
                    <select id="currencyDisplay">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="BTC">BTC (‚Çø)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Layout Management</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn" id="exportLayoutBtn" style="flex: 1;">üì§ Export Layout</button>
                        <button class="btn" id="importLayoutBtn" style="flex: 1;">üì• Import Layout</button>
                        <input type="file" id="importLayoutFile" accept=".json" style="display: none;">
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Export your widget layout to use on other devices
                    </div>
                </div>
            </div>
            
            <!-- Peer Benchmark Tab -->
            <div id="modal-tab-peer" class="modal-tab-content" style="display: none;">
                <div class="form-group">
                    <label>Your Age</label>
                    <input type="number" id="modal-peer-age" min="18" max="100" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label>Region / Country</label>
                    <select id="modal-peer-region" style="width: 100%;">
                        <option value="US">United States</option>
                        <option value="Europe">Euro Area</option>
                        <option value="Portugal">Portugal</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="Asia">Asia (Developed)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Annual Household Income (USD)</label>
                    <input type="number" id="modal-peer-income" min="0" step="5000" style="width: 100%;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Used to compare against peers at similar income levels
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Other Assets (not in portfolio)</label>
                    <input type="number" id="modal-peer-other" min="0" step="10000" style="width: 100%;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        House equity, 401k, other investments, etc.
                    </div>
                </div>
            </div>
            
            <!-- Monte Carlo Tab -->
            <div id="modal-tab-monte" class="modal-tab-content" style="display: none;">
                <div class="form-group">
                    <label>Number of Simulations</label>
                    <input type="number" id="modal-monte-sims" min="100" max="10000" step="100" style="width: 100%;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        More simulations = more accurate but slower (1000 recommended)
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Monthly Volatility (%)</label>
                    <input type="number" id="modal-monte-vol" min="1" max="30" step="1" style="width: 100%;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        8-12% typical for crypto portfolios
                    </div>
                </div>
                
                <div class="form-group">
                    <label>FIRE Target ($)</label>
                    <input type="number" id="modal-monte-fire" min="100000" step="50000" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label>Max Years to Project</label>
                    <input type="number" id="modal-monte-years" min="5" max="30" step="1" style="width: 100%;">
                </div>
            </div>
            
            <!-- Sync & Export Tab -->
            <div id="modal-tab-sync" class="modal-tab-content" style="display: none;">
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">üìä Google Sheets Sync</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Settings are stored in a "Settings" tab in your Google Sheet. This allows you to use the same configuration across different browsers and machines.
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <button class="btn" onclick="loadSettingsFromSheet()" style="flex: 1;" title="Load settings from Google Sheets">
                            ‚¨áÔ∏è Load from Sheet
                        </button>
                        <button class="btn btn-primary" onclick="saveSettingsToSheet()" style="flex: 1;" title="Save current settings to Google Sheets">
                            ‚¨ÜÔ∏è Save to Sheet
                        </button>
                    </div>
                    
                    <div id="syncStatus" style="font-size: 0.8rem; padding: 0.5rem; border-radius: 4px; display: none;"></div>
                </div>
                
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">üîß Apps Script URL</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        To enable saving settings to Google Sheets, deploy the Apps Script and paste the URL here.
                    </div>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/..." 
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                    <button class="btn" onclick="saveAppsScriptUrl()" style="width: 100%;">
                        üíæ Save URL
                    </button>
                    <details style="margin-top: 0.75rem;">
                        <summary style="font-size: 0.8rem; color: var(--accent-blue); cursor: pointer;">üìã Setup Instructions</summary>
                        <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.5rem; line-height: 1.4;">
                            1. Open your Google Sheet<br>
                            2. Go to <strong>Extensions ‚Üí Apps Script</strong><br>
                            3. Replace the code with the script (click "Show Script" below)<br>
                            4. Click <strong>Deploy ‚Üí New deployment</strong><br>
                            5. Select <strong>Web app</strong>, set access to <strong>Anyone</strong><br>
                            6. Click Deploy and copy the URL here
                        </div>
                        <button class="btn" onclick="showAppsScriptCode()" style="width: 100%; margin-top: 0.5rem; font-size: 0.8rem;">
                            üìÑ Show Apps Script Code
                        </button>
                    </details>
                </div>
                
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--accent-red);">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--accent-red); margin-bottom: 0.5rem;">‚ö†Ô∏è Reset All Settings</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Reset all settings to default values. This only affects local storage.
                    </div>
                    <button class="btn" onclick="confirmResetAllSettings()" style="width: 100%; border-color: var(--accent-red); color: var(--accent-red);">
                        Reset to Defaults
                    </button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn" id="closeSettingsBtn">Cancel</button>
                <button class="btn btn-primary" id="saveSettingsBtn">Save & Apply</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Global State
        // ============================================
        let grid = null;
        let charts = {};
        let portfolioData = null;
        let accentColor = '#0ad5ec';
        let colorPalette = [];

        // ============================================
        // Settings Manager - Google Sheets + LocalStorage persistence
        // ============================================
        // Priority: Google Sheets (cross-device) > LocalStorage (fast cache)
        // 
        // Setup: Create a "Settings" sheet tab in your Google Sheet with format:
        // | Key | Value |
        // | peer.age | 47 |
        // | peer.region | US |
        // | peer.income | 75000 |
        // | peer.otherAssets | 0 |
        // | monteCarlo.simulations | 1000 |
        // | monteCarlo.volatility | 10 |
        // | monteCarlo.fireTarget | 1000000 |
        // | display.accentColor | #0ad5ec |
        // ============================================
        
        const SettingsManager = {
            // Default settings
            defaults: {
                version: 1,
                peer: {
                    age: 47,
                    region: 'US',
                    income: 75000,
                    otherAssets: 0,
                    currency: 'USD'
                },
                monteCarlo: {
                    simulations: 1000,
                    volatility: 10,
                    fireTarget: 1000000,
                    yearsToProject: 10
                },
                display: {
                    theme: 'dark',
                    accentColor: '#0ad5ec',
                    compactMode: false
                },
                dataSource: {
                    googleSheetUrl: '',
                    appsScriptUrl: '', // For writing settings back
                    refreshInterval: 0
                }
            },
            
            // Current settings
            current: null,
            
            // Google Apps Script URL for saving (set by user)
            appsScriptUrl: null,
            
            // Initialize from localStorage (fast), then override with Google Sheets data
            init() {
                let settings = this.deepMerge({}, this.defaults);
                
                // Load from localStorage first (fast cache)
                try {
                    const stored = localStorage.getItem('zhodler-dashboard-settings');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        settings = this.deepMerge(settings, parsed);
                        console.log('Settings loaded from localStorage');
                    }
                } catch (e) {
                    console.warn('Failed to load settings from localStorage:', e);
                }
                
                // Migrate old peer config if exists
                try {
                    const oldPeerConfig = localStorage.getItem('zhodler-peer-config');
                    if (oldPeerConfig) {
                        const parsed = JSON.parse(oldPeerConfig);
                        settings.peer = this.deepMerge(settings.peer, parsed);
                        localStorage.removeItem('zhodler-peer-config');
                    }
                } catch (e) {}
                
                // Load Apps Script URL from localStorage
                this.appsScriptUrl = localStorage.getItem('zhodler-apps-script-url') || '';
                
                this.current = settings;
                return settings;
            },
            
            // Load settings from Google Sheets Config tab
            async loadFromGoogleSheets(sheetUrl) {
                try {
                    const sheetId = extractSheetId(sheetUrl);
                    if (!sheetId) return null;
                    
                    // Try to fetch the Settings sheet with cache-busting
                    const cacheBuster = Date.now();
                    const configUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Settings&_cb=${cacheBuster}`;
                    const response = await fetch(configUrl, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        console.log('Settings sheet not found or not accessible');
                        return null;
                    }
                    
                    const csvText = await response.text();
                    const rows = parseCSV(csvText);
                    
                    if (rows.length < 2) {
                        console.log('Settings sheet is empty or has no data rows');
                        return null;
                    }
                    
                    // Parse key-value pairs (skip header row)
                    const settings = {};
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (row.length >= 2 && row[0]) {
                            const key = row[0].trim();
                            let value = row[1]?.trim() || '';
                            
                            // Parse value types
                            if (value === 'true') value = true;
                            else if (value === 'false') value = false;
                            else if (!isNaN(value) && value !== '') value = parseFloat(value);
                            
                            // Set nested property
                            this.setNestedValue(settings, key, value);
                        }
                    }
                    
                    console.log('Settings loaded from Google Sheets Config tab:', settings);
                    
                    // Merge with current settings (Google Sheets takes priority)
                    this.current = this.deepMerge(this.current, settings);
                    this.saveToLocalStorage(); // Cache locally
                    
                    return settings;
                } catch (e) {
                    console.warn('Failed to load settings from Google Sheets:', e);
                    return null;
                }
            },
            
            // Save settings to Google Sheets via Apps Script
            async saveToGoogleSheets() {
                if (!this.appsScriptUrl) {
                    console.log('Apps Script URL not configured - settings saved locally only');
                    return { success: false, reason: 'no_url' };
                }
                
                try {
                    const flatSettings = this.flattenSettings(this.current);
                    
                    const response = await fetch(this.appsScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', // Apps Script requires this
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'saveSettings',
                            settings: flatSettings
                        })
                    });
                    
                    console.log('Settings sent to Google Sheets');
                    return { success: true };
                } catch (e) {
                    console.error('Failed to save settings to Google Sheets:', e);
                    return { success: false, reason: 'error', error: e.message };
                }
            },
            
            // Flatten nested settings to key-value pairs
            flattenSettings(obj, prefix = '') {
                const result = [];
                for (const key in obj) {
                    const fullKey = prefix ? `${prefix}.${key}` : key;
                    if (obj[key] && typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        result.push(...this.flattenSettings(obj[key], fullKey));
                    } else {
                        result.push({ key: fullKey, value: obj[key] });
                    }
                }
                return result;
            },
            
            // Set a nested value from a dot-notation key
            setNestedValue(obj, key, value) {
                const keys = key.split('.');
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) current[keys[i]] = {};
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
            },
            
            // Deep merge helper
            deepMerge(target, source) {
                const result = { ...target };
                for (const key in source) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                        result[key] = this.deepMerge(result[key] || {}, source[key]);
                    } else if (source[key] !== undefined) {
                        result[key] = source[key];
                    }
                }
                return result;
            },
            
            // Get a setting by path (e.g., 'peer.age')
            get(path) {
                if (!this.current) this.init();
                return path.split('.').reduce((obj, key) => obj?.[key], this.current);
            },
            
            // Set a setting by path
            set(path, value) {
                if (!this.current) this.init();
                const keys = path.split('.');
                let obj = this.current;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            },
            
            // Save to localStorage only (fast)
            saveToLocalStorage() {
                try {
                    localStorage.setItem('zhodler-dashboard-settings', JSON.stringify(this.current));
                    console.log('Settings saved to localStorage');
                } catch (e) {
                    console.error('Failed to save settings to localStorage:', e);
                }
            },
            
            // Save to both localStorage and Google Sheets
            async save(alsoToSheets = false) {
                this.saveToLocalStorage();
                
                if (alsoToSheets) {
                    return await this.saveToGoogleSheets();
                }
                return { success: true, local: true };
            },
            
            // Set Apps Script URL
            setAppsScriptUrl(url) {
                this.appsScriptUrl = url;
                localStorage.setItem('zhodler-apps-script-url', url);
            },
            
            // Reset to defaults
            reset() {
                this.current = this.deepMerge({}, this.defaults);
                this.saveToLocalStorage();
            },
            
            // Generate Settings sheet template data
            generateConfigTemplate() {
                const flat = this.flattenSettings(this.defaults);
                let template = 'Key,Value\n';
                for (const item of flat) {
                    if (!item.key.startsWith('version') && !item.key.startsWith('dataSource')) {
                        template += `${item.key},${item.value}\n`;
                    }
                }
                return template;
            }
        };
        
        // Initialize settings on load
        SettingsManager.init();
        
        // ============================================
        // Chart.js Typography Defaults
        // ============================================
        Chart.defaults.font.family = "'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        Chart.defaults.font.size = 13;
        Chart.defaults.font.weight = 500;
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.plugins.legend.labels.font = { size: 12, weight: 500 };
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 600 };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 13, weight: 400 };
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 31, 53, 0.95)';
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(148, 163, 184, 0.2)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.scale.ticks.font = { size: 12, weight: 400 };
        
        // ============================================
        // Settings Sync Functions
        // ============================================
        
        // Load settings from Google Sheets
        async function loadSettingsFromSheet() {
            const statusEl = document.getElementById('syncStatus');
            const sheetUrl = localStorage.getItem('zhodler-sheets-url');
            
            if (!sheetUrl) {
                showSyncStatus('No Google Sheet URL configured. Set it in the Data tab.', 'error');
                return;
            }
            
            showSyncStatus('Loading settings from Google Sheets...', 'info');
            
            try {
                const result = await SettingsManager.loadFromGoogleSheets(sheetUrl);
                if (result) {
                    peerConfig = SettingsManager.current.peer;
                    showSyncStatus('‚úÖ Settings loaded from Google Sheets!', 'success');
                    
                    // Refresh modal inputs if open
                    populateModalInputs();
                    
                    // Refresh widgets
                    if (window.currentDashboardData) {
                        updatePeerBenchmarkWidget(window.currentDashboardData);
                        updateMonteCarloWidget(window.currentDashboardData);
                    }
                } else {
                    showSyncStatus('‚ö†Ô∏è No Settings tab found. Create one with Key/Value columns.', 'warning');
                }
            } catch (e) {
                showSyncStatus('‚ùå Failed to load: ' + e.message, 'error');
            }
        }
        
        // Save settings to Google Sheets via Apps Script
        async function saveSettingsToSheet() {
            const appsScriptUrl = SettingsManager.appsScriptUrl;
            
            if (!appsScriptUrl) {
                showSyncStatus('‚ö†Ô∏è Apps Script URL not configured. See setup instructions below.', 'warning');
                return;
            }
            
            showSyncStatus('Saving settings to Google Sheets...', 'info');
            
            try {
                const result = await SettingsManager.saveToGoogleSheets();
                if (result.success) {
                    showSyncStatus('‚úÖ Settings saved to Google Sheets!', 'success');
                } else {
                    showSyncStatus('‚ö†Ô∏è ' + (result.reason || 'Unknown error'), 'warning');
                }
            } catch (e) {
                showSyncStatus('‚ùå Failed to save: ' + e.message, 'error');
            }
        }
        
        // Save Apps Script URL
        function saveAppsScriptUrl() {
            const url = document.getElementById('appsScriptUrl')?.value?.trim();
            if (url) {
                SettingsManager.setAppsScriptUrl(url);
                showSyncStatus('‚úÖ Apps Script URL saved!', 'success');
            } else {
                showSyncStatus('‚ö†Ô∏è Please enter a valid URL', 'warning');
            }
        }
        
        // Show sync status message
        function showSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            if (!statusEl) return;
            
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            
            const colors = {
                success: { bg: 'rgba(16, 185, 129, 0.2)', border: 'var(--accent-green)', color: 'var(--accent-green)' },
                error: { bg: 'rgba(239, 68, 68, 0.2)', border: 'var(--accent-red)', color: 'var(--accent-red)' },
                warning: { bg: 'rgba(245, 158, 11, 0.2)', border: '#f59e0b', color: '#f59e0b' },
                info: { bg: 'rgba(59, 130, 246, 0.2)', border: 'var(--accent-blue)', color: 'var(--accent-blue)' }
            };
            
            const style = colors[type] || colors.info;
            statusEl.style.background = style.bg;
            statusEl.style.borderLeft = `3px solid ${style.border}`;
            statusEl.style.color = style.color;
        }
        
        // Show Apps Script code in a modal
        function showAppsScriptCode() {
            const code = `// Google Apps Script for Zhodler Dashboard Settings
// Deploy this as a Web App with access set to "Anyone"

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'saveSettings') {
      saveSettings(data.settings);
      return ContentService.createTextOutput(JSON.stringify({ success: true }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ error: 'Unknown action' }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({ status: 'OK', message: 'Settings API ready' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function saveSettings(settings) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('Settings');
  
  // Create Settings sheet if it doesn't exist
  if (!sheet) {
    sheet = ss.insertSheet('Settings');
    sheet.getRange('A1:B1').setValues([['Key', 'Value']]);
    sheet.getRange('A1:B1').setFontWeight('bold');
  }
  
  // Clear existing data (except header)
  const lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    sheet.getRange(2, 1, lastRow - 1, 2).clear();
  }
  
  // Write new settings
  if (settings && settings.length > 0) {
    const values = settings.map(item => [item.key, item.value]);
    sheet.getRange(2, 1, values.length, 2).setValues(values);
  }
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, 2);
}

// Test function - run this to verify setup
function testSetup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  Logger.log('Spreadsheet: ' + ss.getName());
  Logger.log('Setup complete! Deploy as Web App to enable saving.');
}`;
            
            const modal = document.createElement('div');
            modal.id = 'apps-script-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: var(--text-primary);">üìÑ Google Apps Script Code</h3>
                        <button onclick="document.getElementById('apps-script-modal').remove()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                        Copy this code and paste it into your Google Sheet's Apps Script editor (Extensions ‚Üí Apps Script).
                    </div>
                    <pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.8rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${code}</pre>
                    <button onclick="copyAppsScriptCode()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        üìã Copy Code to Clipboard
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // Copy Apps Script code to clipboard
        async function copyAppsScriptCode() {
            const code = document.querySelector('#apps-script-modal pre')?.textContent;
            if (code) {
                try {
                    await navigator.clipboard.writeText(code);
                    showToast('Code copied to clipboard!');
                } catch (e) {
                    showToast('Failed to copy', 'error');
                }
            }
        }
        
        // Populate modal inputs from current settings
        function populateModalInputs() {
            const s = SettingsManager.current;
            
            // Peer settings
            const peerAge = document.getElementById('modal-peer-age');
            const peerRegion = document.getElementById('modal-peer-region');
            const peerIncome = document.getElementById('modal-peer-income');
            const peerOther = document.getElementById('modal-peer-other');
            
            if (peerAge) peerAge.value = s.peer?.age || 47;
            if (peerRegion) peerRegion.value = s.peer?.region || 'US';
            if (peerIncome) peerIncome.value = s.peer?.income || 75000;
            if (peerOther) peerOther.value = s.peer?.otherAssets || 0;
            
            // Monte Carlo settings
            const monteSims = document.getElementById('modal-monte-sims');
            const monteVol = document.getElementById('modal-monte-vol');
            const monteFire = document.getElementById('modal-monte-fire');
            const monteYears = document.getElementById('modal-monte-years');
            
            if (monteSims) monteSims.value = s.monteCarlo?.simulations || 1000;
            if (monteVol) monteVol.value = s.monteCarlo?.volatility || 10;
            if (monteFire) monteFire.value = s.monteCarlo?.fireTarget || 1000000;
            if (monteYears) monteYears.value = s.monteCarlo?.yearsToProject || 10;
            
            // Apps Script URL
            const appsScriptUrl = document.getElementById('appsScriptUrl');
            if (appsScriptUrl) appsScriptUrl.value = SettingsManager.appsScriptUrl || '';
        }
        
        // Reset all settings
        function confirmResetAllSettings() {
            if (confirm('Reset all settings to defaults? This only affects local storage, not Google Sheets.')) {
                SettingsManager.reset();
                peerConfig = SettingsManager.current.peer;
                populateModalInputs();
                showToast('Settings reset to defaults');
                
                if (window.currentDashboardData) {
                    updatePeerBenchmarkWidget(window.currentDashboardData);
                    updateMonteCarloWidget(window.currentDashboardData);
                }
            }
        }
        
        // Toast notification
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 0.75rem 1.5rem;
                background: ${type === 'error' ? 'var(--accent-red)' : 'var(--accent-green)'};
                color: white;
                border-radius: 8px;
                font-size: 0.85rem;
                font-weight: 600;
                z-index: 10002;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: toastSlideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastSlideDown 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
        
        // Add toast animation keyframes
        if (!document.getElementById('toast-keyframes')) {
            const style = document.createElement('style');
            style.id = 'toast-keyframes';
            style.textContent = `
                @keyframes toastSlideUp {
                    from { transform: translateX(-50%) translateY(20px); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
                @keyframes toastSlideDown {
                    from { transform: translateX(-50%) translateY(0); opacity: 1; }
                    to { transform: translateX(-50%) translateY(20px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Switch modal tabs
        function switchModalTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.modal-tab-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.modal-tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = document.getElementById('modal-tab-' + tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            // Activate selected tab button
            const tabButton = document.querySelector(`.modal-tab[data-tab="${tabId}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }

        // ============================================
        // Color Palette Generation
        // ============================================
        
        // Convert hex to HSL
        function hexToHsl(hex) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }
        
        // Convert HSL to hex
        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }
        
        // Generate color palette from base color
        function generatePalette(baseHex) {
            const hsl = hexToHsl(baseHex);
            const palette = [];
            
            // Generate 10 shades with varying lightness and saturation
            const variations = [
                { lOffset: 0, sOffset: 0 },      // Base color
                { lOffset: 15, sOffset: -10 },   // Lighter
                { lOffset: -15, sOffset: 10 },   // Darker
                { lOffset: 25, sOffset: -20 },   // Much lighter
                { lOffset: -25, sOffset: 5 },    // Much darker
                { lOffset: 10, sOffset: 15 },    // More saturated, lighter
                { lOffset: -10, sOffset: 20 },   // More saturated, darker
                { lOffset: 30, sOffset: -30 },   // Very light (pastel)
                { lOffset: -30, sOffset: 0 },    // Very dark
                { lOffset: 5, sOffset: -5 },     // Slight variation
            ];
            
            variations.forEach(v => {
                const newL = Math.max(10, Math.min(90, hsl.l + v.lOffset));
                const newS = Math.max(20, Math.min(100, hsl.s + v.sOffset));
                palette.push(hslToHex(hsl.h, newS, newL));
            });
            
            return palette;
        }
        
        // Get complementary/contrasting color for negative values
        function getContrastColor(baseHex) {
            const hsl = hexToHsl(baseHex);
            // Shift hue by 180 degrees for complement, or use red-ish for negative
            const contrastHue = (hsl.h + 150) % 360;
            return hslToHex(contrastHue, Math.min(90, hsl.s + 10), hsl.l);
        }
        
        // Initialize palette from saved or default color
        function initColorPalette() {
            accentColor = localStorage.getItem('zhodler-accent-color') || '#0ad5ec';
            document.getElementById('accentColorPicker').value = accentColor;
            colorPalette = generatePalette(accentColor);
            updateCSSAccentColors();
        }
        
        // Update CSS custom properties for progress bars
        function updateCSSAccentColors() {
            const root = document.documentElement;
            root.style.setProperty('--chart-color-1', colorPalette[0]);
            root.style.setProperty('--chart-color-2', colorPalette[1]);
            root.style.setProperty('--chart-color-3', colorPalette[2]);
            root.style.setProperty('--chart-color-4', colorPalette[3]);
            root.style.setProperty('--chart-color-5', colorPalette[4]);
            root.style.setProperty('--chart-contrast', getContrastColor(accentColor));
        }
        
        // Handle accent color change
        function onAccentColorChange(newColor) {
            accentColor = newColor;
            colorPalette = generatePalette(accentColor);
            localStorage.setItem('zhodler-accent-color', accentColor);
            updateCSSAccentColors();
            
            // Re-render charts with new colors
            if (portfolioData) {
                updateCharts(portfolioData);
            }
        }

        // Default widget layout - matches reference screenshot
        const defaultLayout = [
            // Row 1: 5 KPI widgets (h:2)
            { id: 'total-value', x: 0, y: 0, w: 3, h: 2 },
            { id: 'yearly-return', x: 3, y: 0, w: 2, h: 2 },
            { id: 'perf-diff', x: 5, y: 0, w: 2, h: 3 },
            { id: 'btc-holdings', x: 7, y: 0, w: 2, h: 2 },
            { id: 'loan-health', x: 9, y: 0, w: 3, h: 2 },
            
            // Row 2: profit averages + new metrics (h:2)
            { id: 'daily-avg-2026', x: 0, y: 2, w: 2, h: 2 },
            { id: 'daily-avg-alltime', x: 2, y: 2, w: 2, h: 2 },
            { id: 'monthly-avg-2026', x: 4, y: 3, w: 2, h: 2 },
            { id: 'monthly-avg-alltime', x: 7, y: 2, w: 2, h: 2 },
            { id: 'cagr', x: 9, y: 2, w: 3, h: 2 },
            
            // Row 3: financial health metrics (h:2)
            { id: 'split-portfolio', x: 0, y: 4, w: 3, h: 2 },
            { id: 'debt-to-asset', x: 3, y: 5, w: 2, h: 2 },
            { id: 'net-worth-velocity', x: 5, y: 5, w: 2, h: 2 },
            { id: 'inflation-adjusted', x: 7, y: 4, w: 3, h: 3 },
            { id: 'peer-benchmark', x: 10, y: 4, w: 2, h: 4 },
            
            // Row 4: 4 chart widgets (h:4)
            { id: 'asset-allocation', x: 0, y: 7, w: 3, h: 4 },
            { id: 'goals-progress', x: 3, y: 7, w: 3, h: 4 },
            { id: 'active-passive-global', x: 6, y: 7, w: 3, h: 4 },
            { id: 'loan-details', x: 9, y: 7, w: 3, h: 4 },
            
            // Row 5: Advanced widgets (h:4)
            { id: 'projections-chart', x: 0, y: 11, w: 4, h: 4 },
            { id: 'monte-carlo', x: 4, y: 11, w: 4, h: 5 },
            { id: 'risk-dashboard', x: 8, y: 11, w: 4, h: 4 },
            
            // Row 6: Timeline and performance widgets (h:4)
            { id: 'time-to-fire', x: 0, y: 15, w: 4, h: 4 },
            { id: 'milestone-timeline', x: 4, y: 15, w: 4, h: 4 },
            { id: 'yearly-performance', x: 8, y: 15, w: 4, h: 4 }
        ];

        // ============================================
        // Utility Functions
        // ============================================
        
        // Tooltip system for info icons
        function showTooltip(event, title, content) {
            event.stopPropagation();
            const popup = document.getElementById('tooltipPopup');
            const titleEl = document.getElementById('tooltipTitle');
            const contentEl = document.getElementById('tooltipContent');
            
            titleEl.textContent = title;
            contentEl.innerHTML = content;
            
            // Position the tooltip near the clicked element
            const rect = event.target.getBoundingClientRect();
            const popupWidth = 320;
            const popupHeight = 200; // estimated
            
            let left = rect.left + rect.width / 2 - popupWidth / 2;
            let top = rect.bottom + 10;
            
            // Keep within viewport
            if (left < 10) left = 10;
            if (left + popupWidth > window.innerWidth - 10) {
                left = window.innerWidth - popupWidth - 10;
            }
            if (top + popupHeight > window.innerHeight - 10) {
                top = rect.top - popupHeight - 10;
            }
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.classList.add('active');
        }
        
        function hideTooltip() {
            document.getElementById('tooltipPopup').classList.remove('active');
        }
        
        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.info-icon') && !e.target.closest('.tooltip-popup')) {
                hideTooltip();
            }
        });
        
        // Risk metric explanations
        const riskTooltips = {
            concentration: {
                title: 'Concentration Risk',
                content: 'Measures how much of your portfolio is concentrated in a single asset. <br><br><strong>Lower is better.</strong> High concentration (>50%) means significant exposure to a single asset\'s performance. Diversification across multiple assets reduces this risk.'
            },
            volatility: {
                title: 'Annual Volatility (œÉ)',
                content: 'Standard deviation of your portfolio\'s annual returns - measures how much returns fluctuate from the average. <br><br><strong>Lower is generally better</strong> for stability. Crypto typically has 50-80% volatility, while traditional stocks have 15-20%.'
            },
            beta: {
                title: 'Beta (vs Bitcoin)',
                content: 'Measures how your portfolio moves relative to Bitcoin. <br><br>‚Ä¢ <strong>Œ≤ = 1.0:</strong> Moves exactly with BTC<br>‚Ä¢ <strong>Œ≤ > 1.0:</strong> More volatile than BTC<br>‚Ä¢ <strong>Œ≤ < 1.0:</strong> Less volatile than BTC<br><br>The "r" value shows correlation strength (-1 to +1).'
            },
            sharpe: {
                title: 'Sharpe Ratio',
                content: 'Risk-adjusted return measure: how much excess return you receive for the volatility you endure. <br><br>‚Ä¢ <strong>>2.0:</strong> Excellent<br>‚Ä¢ <strong>1.0-2.0:</strong> Good<br>‚Ä¢ <strong>0.5-1.0:</strong> Acceptable<br>‚Ä¢ <strong><0.5:</strong> Poor<br><br>Higher is better - means more return per unit of risk.'
            },
            var: {
                title: 'Value at Risk (VaR) 95%',
                content: 'The maximum amount you could lose in a single day with 95% confidence. <br><br>In other words, there\'s only a 5% chance your daily loss will exceed this amount. Based on your portfolio\'s historical volatility.'
            },
            leverage: {
                title: 'Leverage / Debt Ratio',
                content: 'Total debt as a percentage of your portfolio value. <br><br><strong>Lower is safer.</strong> High leverage amplifies both gains and losses. Generally, keeping this under 30% is considered conservative for crypto.'
            },
            ltv: {
                title: 'Loan-to-Value (LTV)',
                content: 'The ratio of your loan amount to your collateral value in Compound. <br><br>‚Ä¢ <strong><50%:</strong> Safe zone<br>‚Ä¢ <strong>50-70%:</strong> Caution zone<br>‚Ä¢ <strong>>70%:</strong> Danger zone<br><br>If LTV exceeds ~83%, your position may be liquidated.'
            },
            liqBuffer: {
                title: 'Liquidation Buffer',
                content: 'How much your collateral (BTC) price can drop before liquidation occurs. <br><br>Shows the percentage drop and the BTC price at which liquidation would trigger. <strong>Larger buffer = safer position.</strong>'
            },
            overall: {
                title: 'Overall Risk Score',
                content: 'Composite score (0-100) combining all risk factors:<br><br>‚Ä¢ Concentration: 20%<br>‚Ä¢ Volatility: 25%<br>‚Ä¢ Leverage: 20%<br>‚Ä¢ Liquidation Risk: 20%<br>‚Ä¢ Sharpe (inverted): 15%<br><br><strong>Lower score = lower risk.</strong>'
            },
            monthlyVar: {
                title: 'Monthly VaR',
                content: 'The maximum amount you could lose in a month with 95% confidence. <br><br>Calculated by scaling daily VaR to monthly timeframe. Useful for longer-term risk planning.'
            }
        };
        
        function formatCurrency(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function formatPercent(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return (value * (Math.abs(value) < 1 ? 100 : 1)).toFixed(decimals) + '%';
        }

        function formatNumber(value, decimals = 4) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return parseFloat(value).toFixed(decimals);
        }

        function getChangeClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return '';
        }

        function parseNumeric(value) {
            if (value === null || value === undefined || value === '') return null;
            if (typeof value === 'number') return isNaN(value) ? null : value;
            if (typeof value === 'string') {
                // Handle special error values from Excel/Sheets
                if (value.startsWith('#') || value === 'NaN' || value === 'N/A') return null;
                // Remove currency symbols, commas, spaces, quotes
                let cleaned = value.replace(/[$,‚Ç¨¬£\s"']/g, '').replace(/[()]/g, '-').trim();
                if (cleaned === '' || cleaned === '-') return null;
                // Handle percentages
                if (cleaned.endsWith('%')) {
                    cleaned = cleaned.slice(0, -1);
                    const num = parseFloat(cleaned);
                    return isNaN(num) ? null : num; // Return as-is, not divided by 100
                }
                const num = parseFloat(cleaned);
                return isNaN(num) ? null : num;
            }
            return null;
        }
        
        // Helper to safely get cell value from row
        function getCell(row, index) {
            if (!row || index >= row.length) return null;
            const val = row[index];
            if (val === '' || val === undefined) return null;
            return val;
        }

        // ============================================
        // Data Loading from Google Sheets
        // ============================================
        
        // Sheet names to fetch
        const SHEET_NAMES = [
            'Performance',
            'BTCCrypto', 
            'Loans',
            'AssetDistro',
            'Split folio',
            'Goals',
            'Projections',
            'TimePassed'
        ];
        
        function extractSheetId(url) {
            // Extract sheet ID from various Google Sheets URL formats
            const patterns = [
                /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
                /^([a-zA-Z0-9-_]+)$/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        async function fetchSheetAsCSV(sheetId, sheetName) {
            // Use Google's visualization API to get CSV data
            // Add multiple cache-busting parameters to defeat all caching layers
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(7);
            const cacheBuster = `${timestamp}_${random}`;
            
            // Primary URL with cache busting
            const baseUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&_=${cacheBuster}&nocache=${timestamp}`;
            
            const corsProxies = [
                '', // Direct first
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url='
            ];
            
            console.log(`Fetching sheet: ${sheetName}`);
            console.log(`  Cache bust: ${cacheBuster}`);
            
            for (let i = 0; i < corsProxies.length; i++) {
                const proxy = corsProxies[i];
                const url = proxy ? (proxy.includes('allorigins') ? proxy + encodeURIComponent(baseUrl) : proxy + baseUrl) : baseUrl;
                
                console.log(`  Trying ${proxy || 'direct'}...`);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-store', // Prevent browser from caching
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Check if we got an error page instead of CSV
                    if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<html') || csvText.includes('unavailable')) {
                        throw new Error('Got HTML instead of CSV');
                    }
                    
                    console.log(`  ‚úì Success via ${proxy || 'direct'}`);
                    return parseCSV(csvText);
                } catch (err) {
                    console.warn(`  ‚úó Failed via ${proxy || 'direct'}:`, err.message);
                    if (i === corsProxies.length - 1) {
                        throw new Error(`Could not load ${sheetName}: All methods failed`);
                    }
                }
            }
        }
        
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let insideQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++; // Skip next quote
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    if (currentRow.some(cell => cell !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                    if (char === '\r') i++; // Skip \n after \r
                } else if (char !== '\r') {
                    currentCell += char;
                }
            }
            
            // Don't forget the last cell/row
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                if (currentRow.some(cell => cell !== '')) {
                    rows.push(currentRow);
                }
            }
            
            return rows;
        }
        
        async function loadFromGoogleSheets(sheetUrl) {
            const sheetId = extractSheetId(sheetUrl);
            if (!sheetId) {
                throw new Error('Invalid Google Sheets URL. Please check the URL and try again.');
            }
            
            console.log('Sheet ID:', sheetId);
            
            const sheets = {};
            const errors = [];
            
            for (let i = 0; i < SHEET_NAMES.length; i++) {
                const sheetName = SHEET_NAMES[i];
                showStatus(`Loading ${sheetName}... (${i + 1}/${SHEET_NAMES.length})`, 'info');
                
                try {
                    sheets[sheetName] = await fetchSheetAsCSV(sheetId, sheetName);
                    console.log(`Loaded ${sheetName}: ${sheets[sheetName].length} rows`);
                } catch (err) {
                    console.warn(`Could not load sheet ${sheetName}:`, err.message);
                    errors.push(sheetName);
                }
            }
            
            if (Object.keys(sheets).length === 0) {
                throw new Error(
                    'Could not load any sheets. Please check:\n' +
                    '1. The spreadsheet is published (File ‚Üí Share ‚Üí Publish to web)\n' +
                    '2. You clicked "Publish" in the dialog\n' +
                    '3. Check browser console (F12) for details'
                );
            }
            
            if (errors.length > 0) {
                console.warn('Some sheets could not be loaded:', errors);
            }
            
            return sheets;
        }

        function processData(sheets) {
            const data = {
                performance: {},
                btcCrypto: {},
                loans: {},
                assetDistro: [],
                goals: [],
                projections: [],
                timePassed: {},
                pools: [],
                fire: {}
            };

            console.log('Processing sheets:', Object.keys(sheets));

            // Process Performance sheet
            if (sheets['Performance'] && sheets['Performance'].length > 1) {
                const perf = sheets['Performance'];
                console.log('Processing Performance, rows:', perf.length);
                console.log('Performance headers:', perf[0]);
                
                // Row 1 has the main KPI data (row 0 is headers)
                if (perf[1] && perf[1].length > 0) {
                    console.log('Performance row 1:', perf[1]);
                    data.performance = {
                        totalValue: parseNumeric(perf[1][0]),
                        totalGain: parseNumeric(perf[1][1]),
                        dailyAvg: parseNumeric(perf[1][2]),
                        monthlyAvg: parseNumeric(perf[1][3]),
                        allTimePercent: parseNumeric(perf[1][4]),
                        yearlyGain2026: parseNumeric(perf[1][6]),
                        dailyAvg2026: parseNumeric(perf[1][7]),
                        monthlyAvg2026: parseNumeric(perf[1][8]),
                        yearlyPercent2026: parseNumeric(perf[1][9]),
                        target2026Percent: parseNumeric(perf[1][10]),
                        target2026Value: parseNumeric(perf[1][11]),
                        achievedTargetPercent: parseNumeric(perf[1][12]),
                        compoundRate2026: parseNumeric(perf[1][13]),
                        apr2026: parseNumeric(perf[1][14]),
                        allTimeCompound: parseNumeric(perf[1][15]),
                        allTimeApr: parseNumeric(perf[1][16]),
                        threshold: parseNumeric(perf[1][17]),
                        perfDiffBtcVsPortfolio: parseNumeric(perf[1][18]),
                        projCompoundEoY: parseNumeric(perf[1][19]),
                        hyperliquidValue: parseNumeric(perf[1][20]),
                        allTimeEarned: parseNumeric(perf[1][21]),
                        hyperliquidROI: parseNumeric(perf[1][23])
                    };
                    console.log('Parsed performance:', data.performance);
                    console.log('Perf Diff BTC vs Portfolio:', data.performance.perfDiffBtcVsPortfolio);
                }
                
                // Solo portfolio (row 5)
                if (perf[5]) {
                    data.performance.soloPortfolio = parseNumeric(perf[5][0]);
                }
                
                // Yearly breakdown - search for rows with year values (2024, 2025, 2026, etc.)
                data.performance.yearly = [];
                for (let i = 0; i < perf.length; i++) {
                    const row = perf[i];
                    if (row && row[0]) {
                        const yearVal = String(row[0]).trim();
                        // Check if it's a year (4 digit number starting with 20)
                        if (/^20\d{2}$/.test(yearVal)) {
                            const yearData = {
                                year: yearVal,
                                percent: parseNumeric(row[1]),
                                value: parseNumeric(row[2]),
                                profit: parseNumeric(row[3]),
                                invested: parseNumeric(row[4]),
                                btc: parseNumeric(row[5])
                            };
                            console.log(`Found yearly data at row ${i}:`, yearData);
                            data.performance.yearly.push(yearData);
                        }
                    }
                }
                console.log('Parsed yearly performance:', data.performance.yearly);
            }

            // Process BTCCrypto sheet
            if (sheets['BTCCrypto'] && sheets['BTCCrypto'].length > 1) {
                const btc = sheets['BTCCrypto'];
                console.log('Processing BTCCrypto, rows:', btc.length);
                
                if (btc[1] && btc[1].length > 0) {
                    data.btcCrypto = {
                        btcPriceJan24: parseNumeric(btc[1][0]),
                        btcIncreaseSinceJan24: parseNumeric(btc[1][1]),
                        initialBtcValue2024: parseNumeric(btc[1][2]),
                        fiatInvested: parseNumeric(btc[1][3]),
                        totalInvestedGlobal: parseNumeric(btc[1][4]),
                        totalInvestedSolo: parseNumeric(btc[1][5]),
                        btcCollateral: parseNumeric(btc[1][6]),
                        jupSolCollateral: parseNumeric(btc[1][7]),
                        collateralValue: parseNumeric(btc[1][8]),
                        totalBtcExposure: parseNumeric(btc[1][9]),
                        btcPriceStart2026: parseNumeric(btc[1][10]),
                        btcPriceToday: parseNumeric(btc[1][11]),
                        btcIncrease2026: parseNumeric(btc[1][12]),
                        btcInitial2026: parseNumeric(btc[1][13]),
                        btcInitialValue2026: parseNumeric(btc[1][14]),
                        cryptoInitial2026: parseNumeric(btc[1][15]),
                        totalInitial2026: parseNumeric(btc[1][16]),
                        added2026: parseNumeric(btc[1][17]),
                        totalApplied2026: parseNumeric(btc[1][18])
                    };
                    console.log('Parsed btcCrypto:', data.btcCrypto);
                }
            }

            // Process Loans sheet
            if (sheets['Loans']) {
                const loans = sheets['Loans'];
                if (loans[1]) {
                    data.loans = {
                        borrowed: Math.abs(parseNumeric(loans[1][0]) || parseNumeric(loans[2][0])),
                        btcPrice: parseNumeric(loans[1][1]),
                        collateralValue: parseNumeric(loans[1][2]),
                        maxBorrow: parseNumeric(loans[1][3]),
                        maxSafeBorrow: parseNumeric(loans[1][4]),
                        ratio: parseNumeric(loans[1][5]),
                        ltv45DebtValue: parseNumeric(loans[1][6]),
                        liquidationPrice: parseNumeric(loans[1][7]),
                        dropToLiquidation: parseNumeric(loans[1][12])
                    };
                    
                    // Time to 45% LTV
                    if (loans[7]) {
                        data.loans.amountBorrowed = parseNumeric(loans[7][1]);
                        data.loans.borrowApr = parseNumeric(loans[7][2]);
                        data.loans.amountProducing = parseNumeric(loans[7][3]);
                        data.loans.yieldApr = parseNumeric(loans[7][4]);
                        data.loans.timeToRepayDays = parseNumeric(loans[7][5]);
                    }
                    
                    // Total debt info
                    if (loans[16]) {
                        data.loans.totalDebt = parseNumeric(loans[16][2]);
                    }
                    if (loans[17]) {
                        data.loans.dailyPayment = parseNumeric(loans[17][2]);
                    }
                    if (loans[18]) {
                        data.loans.daysToPayOff = parseNumeric(loans[18][2]);
                    }
                    
                    // Debt for Active vs Passive chart
                    // Note: CSV export skips empty rows, so A26 in Excel becomes row 15 in CSV
                    // The debt value is the large negative number around -40405
                    if (loans[15] && loans[15][0]) {
                        data.loans.debtForChart = parseNumeric(loans[15][0]);
                        console.log('Debt for chart (from row 15):', data.loans.debtForChart);
                    } else {
                        // Fallback: search for large negative value
                        for (let i = 0; i < loans.length; i++) {
                            const val = parseNumeric(loans[i] && loans[i][0]);
                            if (val && val < -10000) {
                                data.loans.debtForChart = val;
                                console.log(`Debt found at row ${i}:`, val);
                                break;
                            }
                        }
                    }
                }
            }

            // Process AssetDistro sheet
            if (sheets['AssetDistro']) {
                const assets = sheets['AssetDistro'];
                console.log('Processing AssetDistro, rows:', assets.length);
                
                // Initialize chain and method data
                data.chainDistro = [];
                data.methodDistro = [];
                
                for (let i = 1; i < assets.length; i++) {
                    const row = assets[i];
                    
                    // Asset data (columns 0-4) - mark as global portfolio
                    if (row[0] && row[4] && !isNaN(parseNumeric(row[4]))) {
                        const assetName = String(row[0]).trim();
                        const value = parseNumeric(row[4]);
                        if (value > 0) {
                            data.assetDistro.push({
                                asset: assetName,
                                amount: parseNumeric(row[1]),
                                price: parseNumeric(row[3]),
                                value: value,
                                source: 'global'
                            });
                        }
                    }
                    
                    // Chain distribution - look for chain names
                    const chainName = String(row[17] || '').trim();
                    if (['Base', 'Solana', 'arbitrum', 'Ethereum'].includes(chainName)) {
                        const chainValue = parseNumeric(row[18]);
                        if (chainValue && chainValue > 0) {
                            data.chainDistro.push({
                                name: chainName,
                                value: chainValue
                            });
                        }
                    }
                }
                
                // Active/Passive chart data - GLOBAL
                // BTC collateral: BTCCrypto I2 (col 8)
                // Debt: Loans A26 (row 15 in CSV due to empty row skipping)
                // Pooled stable: AssetDistro H2 (col 7)
                // Volatiles: AssetDistro N2 (col 13)
                // Balance: AssetDistro P2 (col 15)
                if (assets[1]) {
                    data.activePassiveGlobal = {
                        btcCollateral: null,  // Will be filled from BTCCrypto
                        pooledStable: parseNumeric(assets[1][7]),    // AssetDistro H2 (col 7)
                        volatiles: parseNumeric(assets[1][13]),       // AssetDistro N2 (col 13)
                        balance: parseNumeric(assets[1][15])          // AssetDistro P2 (col 15)
                    };
                }
                
                // Risk distribution (column 7)
                if (assets[1]) {
                    data.riskDistro = {
                        stables: parseNumeric(assets[1][7]),
                        medVolatile: parseNumeric(assets[2] ? assets[2][7] : 0),
                        highVolatile: parseNumeric(assets[3] ? assets[3][7] : 0)
                    };
                }
                
                // Method distribution (column 6-7 rows 6-9)
                for (let i = 6; i <= 9; i++) {
                    if (assets[i] && assets[i][6]) {
                        const methodName = String(assets[i][6]).trim();
                        const methodValue = parseNumeric(assets[i][7]);
                        if (methodName && methodValue && methodValue > 0) {
                            data.methodDistro.push({
                                name: methodName,
                                value: methodValue
                            });
                        }
                    }
                }
                
                console.log('AssetDistro processed:', data.assetDistro.length, 'assets');
                console.log('Chain distribution:', data.chainDistro);
                console.log('Method distribution:', data.methodDistro);
            }
            
            // Process Split folio sheet and merge with AssetDistro
            // Add HALF of the Split folio values (shared portfolio)
            if (sheets['Split folio']) {
                const splitFolio = sheets['Split folio'];
                console.log('Processing Split folio, rows:', splitFolio.length);
                
                let splitPortfolioTotal = 0;
                
                for (let i = 1; i < splitFolio.length; i++) {
                    const row = splitFolio[i];
                    
                    // Asset data (columns 0-4)
                    const assetName = row[0] ? String(row[0]).trim() : '';
                    const fullValue = parseNumeric(row[4]);
                    const halfValue = fullValue / 2;  // Only count half of split folio
                    
                    // Skip if no name or no value
                    if (!assetName || assetName === 'nan' || !fullValue || fullValue <= 0) continue;
                    
                    // Add to split portfolio total (full value)
                    splitPortfolioTotal += fullValue;
                    
                    // Always add Split folio assets with (Split) suffix
                    data.assetDistro.push({
                        asset: assetName + ' (Split)',
                        amount: parseNumeric(row[1]) / 2,
                        price: parseNumeric(row[3]),
                        value: halfValue,
                        source: 'split'
                    });
                    console.log('Added Split folio asset:', assetName, 'half value:', halfValue);
                }
                
                // Store split portfolio total value
                data.splitPortfolio = {
                    totalValue: splitPortfolioTotal,
                    halfValue: splitPortfolioTotal / 2
                };
                console.log('Split portfolio total:', splitPortfolioTotal, 'Your half:', splitPortfolioTotal / 2);
                
                console.log('After Split folio merge:', data.assetDistro.length, 'total assets');
            }

            // Process Goals sheet
            if (sheets['Goals']) {
                const goals = sheets['Goals'];
                console.log('Processing Goals sheet, rows:', goals.length);
                console.log('Goals raw data:', goals);
                
                // FIRE calculations - capture both scenarios (rows 1 and 2)
                data.fire = { scenarios: [] };
                
                // First scenario (row 1)
                if (goals[1]) {
                    data.fire.scenarios.push({
                        label: 'Conservative',
                        monthlyWage: parseNumeric(goals[1][0]),
                        monthlyCompound: parseNumeric(goals[1][1]),
                        totalMonthly: parseNumeric(goals[1][2]),
                        criticalMassValue: parseNumeric(goals[1][3]),
                        criticalMassPooled: parseNumeric(goals[1][4]),
                        multiplier: parseNumeric(goals[1][5]),
                        timeToFireDays: parseNumeric(goals[1][6]),
                        timeToFireYears: parseNumeric(goals[1][7]),
                        timeToFireMonths: parseNumeric(goals[1][8]),
                        timeToFireExtraDays: parseNumeric(goals[1][9]),
                        targetDailyIncome: parseNumeric(goals[1][10])
                    });
                }
                
                // Second scenario (row 2)
                if (goals[2] && parseNumeric(goals[2][0])) {
                    data.fire.scenarios.push({
                        label: 'Aggressive',
                        monthlyWage: parseNumeric(goals[2][0]),
                        monthlyCompound: parseNumeric(goals[2][1]),
                        totalMonthly: parseNumeric(goals[2][2]),
                        criticalMassValue: parseNumeric(goals[2][3]),
                        criticalMassPooled: parseNumeric(goals[2][4]),
                        multiplier: parseNumeric(goals[2][5]),
                        timeToFireDays: parseNumeric(goals[2][6]),
                        timeToFireYears: parseNumeric(goals[2][7]),
                        timeToFireMonths: parseNumeric(goals[2][8]),
                        timeToFireExtraDays: parseNumeric(goals[2][9]),
                        targetDailyIncome: parseNumeric(goals[2][10])
                    });
                }
                
                // Set primary fire data for backward compatibility
                if (data.fire.scenarios.length > 0) {
                    Object.assign(data.fire, data.fire.scenarios[0]);
                }
                
                console.log('Parsed FIRE data:', data.fire);
                
                // Individual goals - search for rows that start with "goal"
                for (let i = 0; i < goals.length; i++) {
                    const row = goals[i];
                    if (row && row[0] && typeof row[0] === 'string' && row[0].toLowerCase().startsWith('goal')) {
                        const goal = {
                            name: row[0],
                            description: row[1] || '',
                            target: parseNumeric(row[2]),
                            current: parseNumeric(row[3]),
                            percent: parseNumeric(row[4])
                        };
                        console.log(`Found goal at row ${i}:`, goal);
                        data.goals.push(goal);
                    }
                }
                console.log('Parsed goals:', data.goals);
            }

            // Process Projections sheet
            if (sheets['Projections']) {
                const proj = sheets['Projections'];
                for (let i = 1; i < Math.min(proj.length, 30); i++) {
                    const row = proj[i];
                    if (row[0] !== undefined) {
                        const totalAdded = parseNumeric(row[15]) || 0;  // Column P: total added (cumulative)
                        data.projections.push({
                            week: row[0],
                            date: row[1],
                            projBal: parseNumeric(row[4]) + totalAdded,           // Add total added to projection
                            projBalAllTime: parseNumeric(row[8]) + totalAdded,    // Add total added to conservative projection
                            projBalCurrent: parseNumeric(row[12]) + totalAdded,   // Add total added to current projection
                            added: parseNumeric(row[14]) || 0,                     // Column O: added this period
                            totalAdded: totalAdded                                 // Column P: cumulative added
                        });
                    }
                }
                console.log('Projections with added values:', data.projections.slice(0, 5));
            }

            // Process TimePassed sheet
            if (sheets['TimePassed']) {
                const time = sheets['TimePassed'];
                if (time[1]) {
                    data.timePassed = {
                        startDate: time[1][0],
                        today: time[1][1],
                        daysPassed: parseNumeric(time[1][2]),
                        yearStart: time[1][3],
                        daysThisYear: parseNumeric(time[1][4]),
                        yearPercent: parseNumeric(time[1][5]),
                        retirementDate: time[1][9],
                        preRetirementDate: time[1][10]
                    };
                }
            }
            
            // Post-processing: Merge data for Active vs Passive chart
            if (data.activePassiveGlobal) {
                // Add BTC collateral from BTCCrypto sheet (col I = index 8)
                if (data.btcCrypto && data.btcCrypto.collateralValue) {
                    data.activePassiveGlobal.btcCollateral = data.btcCrypto.collateralValue;
                }
                
                // Add debt from Loans sheet
                if (data.loans && data.loans.debtForChart !== undefined) {
                    data.activePassiveGlobal.debt = data.loans.debtForChart;
                }
                
                console.log('Active/Passive Global data:', data.activePassiveGlobal);
            }

            return data;
        }

        // ============================================
        // Widget Creation
        // ============================================
        function createWidgetHTML(id) {
            const widgets = {
                'total-value': `
                    <div class="widget-header">
                        <span class="widget-title">Total Portfolio Value</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-total-value">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-total-change">--</div>
                        <div class="kpi-label">All-time gain</div>
                    </div>
                `,
                'yearly-return': `
                    <div class="widget-header">
                        <span class="widget-title">2026 Performance</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-yearly-return">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-yearly-gain">--</div>
                        <div class="kpi-label">Target: 75%</div>
                    </div>
                `,
                'btc-holdings': `
                    <div class="widget-header">
                        <span class="widget-title">BTC Holdings</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-btc-amount">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-btc-value">--</div>
                        <div class="kpi-label" id="kpi-btc-price">BTC Price: --</div>
                    </div>
                `,
                'loan-health': `
                    <div class="widget-header">
                        <span class="widget-title">Loan Health</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-loan-ratio">--</div>
                        <div class="kpi-change" id="kpi-loan-status">--</div>
                        <div class="kpi-label sensitive-data" id="kpi-liq-distance">Distance to liquidation: --</div>
                    </div>
                `,
                'perf-diff': `
                    <div class="widget-header">
                        <span class="widget-title">Portfolio vs Benchmarks</span>
                    </div>
                    <div class="widget-body sensitive-data">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div>
                                <div class="kpi-value" id="kpi-perf-diff" style="font-size: 1.5rem;">--</div>
                                <div class="kpi-change" id="kpi-perf-diff-status" style="font-size: 0.8rem;">vs BTC</div>
                            </div>
                            <div style="border-top: 1px solid var(--border-color); padding-top: 0.5rem;">
                                <div class="kpi-value" id="kpi-perf-sp500" style="font-size: 1.5rem;">--</div>
                                <div class="kpi-change" id="kpi-perf-sp500-status" style="font-size: 0.8rem;">vs S&P 500</div>
                            </div>
                        </div>
                    </div>
                `,
                'active-passive-global': `
                    <div class="widget-header">
                        <span class="widget-title">Active vs Passive - Global</span>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container sensitive-data">
                            <canvas id="chart-active-passive"></canvas>
                        </div>
                    </div>
                `,
                'asset-allocation': `
                    <div class="widget-header">
                        <span class="widget-title">Asset Allocation</span>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container sensitive-data">
                            <canvas id="chart-asset-allocation"></canvas>
                        </div>
                    </div>
                `,
                'goals-progress': `
                    <div class="widget-header">
                        <span class="widget-title">Goals Progress</span>
                    </div>
                    <div class="widget-body sensitive-data" id="goals-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'loan-details': `
                    <div class="widget-header">
                        <span class="widget-title">Loan Details</span>
                    </div>
                    <div class="widget-body sensitive-data" id="loan-details-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'projections-chart': `
                    <div class="widget-header">
                        <span class="widget-title">Portfolio Projections</span>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container sensitive-data">
                            <canvas id="chart-projections"></canvas>
                        </div>
                    </div>
                `,
                'yearly-performance': `
                    <div class="widget-header">
                        <span class="widget-title">Yearly Performance</span>
                    </div>
                    <div class="widget-body">
                        <div class="chart-container sensitive-data">
                            <canvas id="chart-yearly"></canvas>
                        </div>
                    </div>
                `,
                'time-to-fire': `
                    <div class="widget-header">
                        <span class="widget-title">Time to FIRE</span>
                    </div>
                    <div class="widget-body sensitive-data" id="fire-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'daily-avg-2026': `
                    <div class="widget-header">
                        <span class="widget-title">Daily Avg (2026)</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-daily-avg-2026">--</div>
                        <div class="kpi-change">per day</div>
                        <div class="kpi-label">Average profit in 2026</div>
                    </div>
                `,
                'daily-avg-alltime': `
                    <div class="widget-header">
                        <span class="widget-title">Daily Avg (All-time)</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-daily-avg-alltime">--</div>
                        <div class="kpi-change">per day</div>
                        <div class="kpi-label">Average profit all-time</div>
                    </div>
                `,
                'monthly-avg-2026': `
                    <div class="widget-header">
                        <span class="widget-title">Monthly Avg (2026)</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-monthly-avg-2026">--</div>
                        <div class="kpi-change">per month</div>
                        <div class="kpi-label">Average profit in 2026</div>
                    </div>
                `,
                'monthly-avg-alltime': `
                    <div class="widget-header">
                        <span class="widget-title">Monthly Avg (All-time)</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-monthly-avg-alltime">--</div>
                        <div class="kpi-change">per month</div>
                        <div class="kpi-label">Average profit all-time</div>
                    </div>
                `,
                'split-portfolio': `
                    <div class="widget-header">
                        <span class="widget-title">Split Portfolio</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-split-total">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-split-half">--</div>
                        <div class="kpi-label">Your half of shared portfolio</div>
                    </div>
                `,
                'cagr': `
                    <div class="widget-header">
                        <span class="widget-title">CAGR</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-cagr">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-cagr-years">--</div>
                        <div class="kpi-label">Compound Annual Growth Rate</div>
                    </div>
                `,
                'debt-to-asset': `
                    <div class="widget-header">
                        <span class="widget-title">Debt-to-Asset Ratio</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-debt-ratio">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-debt-details">--</div>
                        <div class="kpi-label">Total debt / Total assets</div>
                    </div>
                `,
                'net-worth-velocity': `
                    <div class="widget-header">
                        <span class="widget-title">Net Worth Velocity</span>
                    </div>
                    <div class="widget-body">
                        <div class="kpi-value sensitive-data" id="kpi-nw-velocity">--</div>
                        <div class="kpi-change sensitive-data" id="kpi-nw-monthly">--</div>
                        <div class="kpi-label">Rate of wealth accumulation</div>
                    </div>
                `,
                'monte-carlo': `
                    <div class="widget-header">
                        <span class="widget-title">Monte Carlo FIRE Simulation</span>
                    </div>
                    <div class="widget-body sensitive-data" id="monte-carlo-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'inflation-adjusted': `
                    <div class="widget-header">
                        <span class="widget-title">Inflation-Adjusted Returns</span>
                    </div>
                    <div class="widget-body sensitive-data" id="inflation-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'milestone-timeline': `
                    <div class="widget-header">
                        <span class="widget-title">Milestone Timeline</span>
                    </div>
                    <div class="widget-body sensitive-data" id="milestone-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'risk-dashboard': `
                    <div class="widget-header">
                        <span class="widget-title">Risk Dashboard</span>
                    </div>
                    <div class="widget-body sensitive-data" id="risk-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `,
                'peer-benchmark': `
                    <div class="widget-header">
                        <span class="widget-title">Peer Benchmarking</span>
                    </div>
                    <div class="widget-body sensitive-data" id="peer-container">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `
            };
            
            return widgets[id] || '<div class="loading">Widget not found</div>';
        }

        // ============================================
        // Dashboard Initialization
        // ============================================
        function initDashboard() {
            const savedLayout = localStorage.getItem('zhodler-layout');
            let layout = savedLayout ? JSON.parse(savedLayout) : defaultLayout;
            
            // Valid widget IDs
            const validWidgetIds = [
                'total-value', 'yearly-return', 'btc-holdings', 'loan-health',
                'perf-diff', 'active-passive-global', 'asset-allocation', 
                'goals-progress', 'loan-details', 'projections-chart',
                'yearly-performance', 'time-to-fire',
                'daily-avg-2026', 'daily-avg-alltime', 'monthly-avg-2026',
                'monthly-avg-alltime', 'split-portfolio',
                'cagr', 'debt-to-asset', 'net-worth-velocity',
                'monte-carlo', 'inflation-adjusted',
                'milestone-timeline', 'risk-dashboard', 'peer-benchmark'
            ];
            
            // Clean up saved layout
            if (savedLayout) {
                // Remove any widgets that no longer exist
                const invalidWidgets = layout.filter(item => !validWidgetIds.includes(item.id));
                if (invalidWidgets.length > 0) {
                    console.log('üóëÔ∏è Removing invalid widgets from saved layout:', invalidWidgets.map(w => w.id));
                    layout = layout.filter(item => validWidgetIds.includes(item.id));
                }
                
                // Add any missing widgets
                const savedIds = layout.map(item => item.id);
                const missingWidgets = defaultLayout.filter(item => !savedIds.includes(item.id));
                
                if (missingWidgets.length > 0) {
                    console.log('üîß Adding missing widgets to saved layout:', missingWidgets.map(w => w.id));
                    const maxY = Math.max(...layout.map(item => item.y + item.h), 0);
                    missingWidgets.forEach((widget, index) => {
                        layout.push({
                            ...widget,
                            y: maxY + (index * 4)
                        });
                    });
                }
                
                // Save the cleaned layout
                if (invalidWidgets.length > 0 || missingWidgets.length > 0) {
                    localStorage.setItem('zhodler-layout', JSON.stringify(layout));
                }
            }
            
            console.log('üìä Initializing dashboard with layout:', layout.map(l => l.id));

            grid = GridStack.init({
                column: 12,
                cellHeight: 80,
                margin: 0,
                float: false,
                resizable: { handles: 'e,se,s,sw,w' },
                draggable: { handle: '.widget-header' }
            });

            layout.forEach(item => {
                const widgetHtml = createWidgetHTML(item.id);
                if (widgetHtml.includes('Widget not found')) {
                    console.warn('‚ö†Ô∏è Widget not found:', item.id);
                    return; // Skip invalid widgets
                }
                grid.addWidget({
                    id: item.id,
                    x: item.x,
                    y: item.y,
                    w: item.w,
                    h: item.h,
                    content: `<div class="grid-stack-item-content">${widgetHtml}</div>`
                });
            });

            // Save layout on change
            grid.on('change', saveLayout);
            
            // Log canvas elements for debugging
            setTimeout(() => {
                const canvases = document.querySelectorAll('canvas');
                console.log('üìà Canvas elements found:', Array.from(canvases).map(c => c.id));
            }, 100);
        }

        function saveLayout() {
            const items = grid.getGridItems();
            const layout = items.map(el => {
                const node = el.gridstackNode;
                return {
                    id: node.id,
                    x: node.x,
                    y: node.y,
                    w: node.w,
                    h: node.h
                };
            });
            localStorage.setItem('zhodler-layout', JSON.stringify(layout));
        }

        function resetLayout() {
            console.log('üîÑ Resetting layout to default...');
            localStorage.removeItem('zhodler-layout');
            grid.removeAll();
            defaultLayout.forEach(item => {
                grid.addWidget({
                    id: item.id,
                    x: item.x,
                    y: item.y,
                    w: item.w,
                    h: item.h,
                    content: `<div class="grid-stack-item-content">${createWidgetHTML(item.id)}</div>`
                });
            });
            
            // Re-render charts after a short delay
            if (portfolioData) {
                setTimeout(() => {
                    updateDashboard(portfolioData);
                    console.log('‚úÖ Layout reset complete');
                }, 100);
            }
            
            // Re-apply lock state after reset
            const isLocked = localStorage.getItem('zhodler-layout-locked') === 'true';
            if (isLocked) {
                setLayoutLocked(true);
            }
        }

        function toggleLayoutLock() {
            const isLocked = localStorage.getItem('zhodler-layout-locked') === 'true';
            setLayoutLocked(!isLocked);
        }
        
        function setLayoutLocked(locked) {
            const btn = document.getElementById('lockLayoutBtn');
            
            if (locked) {
                grid.enableMove(false);
                grid.enableResize(false);
                btn.textContent = 'üîí Locked';
                btn.classList.add('locked');
                localStorage.setItem('zhodler-layout-locked', 'true');
                console.log('üîí Layout locked');
            } else {
                grid.enableMove(true);
                grid.enableResize(true);
                btn.textContent = 'üîì Unlocked';
                btn.classList.remove('locked');
                localStorage.setItem('zhodler-layout-locked', 'false');
                console.log('üîì Layout unlocked');
            }
        }
        
        function initLayoutLock() {
            const isLocked = localStorage.getItem('zhodler-layout-locked') === 'true';
            if (isLocked) {
                setLayoutLocked(true);
            }
        }

        function exportLayout() {
            const items = grid.getGridItems();
            const layout = items.map(el => {
                const node = el.gridstackNode;
                return {
                    id: node.id,
                    x: node.x,
                    y: node.y,
                    w: node.w,
                    h: node.h
                };
            });
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                theme: localStorage.getItem('zhodler-theme') || 'default',
                sheetsUrl: localStorage.getItem('zhodler-sheets-url') || '',
                locked: localStorage.getItem('zhodler-layout-locked') === 'true',
                layout: layout
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zhodler-layout-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('üì§ Layout exported');
            alert('Layout exported successfully!');
        }

        function importLayout(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.layout || !Array.isArray(importData.layout)) {
                        throw new Error('Invalid layout file');
                    }
                    
                    // Save imported settings
                    localStorage.setItem('zhodler-layout', JSON.stringify(importData.layout));
                    
                    if (importData.theme) {
                        localStorage.setItem('zhodler-theme', importData.theme);
                        document.getElementById('themeSelect').value = importData.theme;
                        setTheme(importData.theme);
                    }
                    
                    if (importData.sheetsUrl) {
                        localStorage.setItem('zhodler-sheets-url', importData.sheetsUrl);
                        document.getElementById('sheetsUrl').value = importData.sheetsUrl;
                    }
                    
                    // Apply the layout
                    grid.removeAll();
                    importData.layout.forEach(item => {
                        grid.addWidget({
                            id: item.id,
                            x: item.x,
                            y: item.y,
                            w: item.w,
                            h: item.h,
                            content: `<div class="grid-stack-item-content">${createWidgetHTML(item.id)}</div>`
                        });
                    });
                    
                    // Apply lock state
                    if (importData.locked !== undefined) {
                        setLayoutLocked(importData.locked);
                    }
                    
                    // Re-render charts
                    if (portfolioData) {
                        setTimeout(() => updateDashboard(portfolioData), 100);
                    }
                    
                    console.log('üì• Layout imported successfully');
                    alert('Layout imported successfully!');
                    
                    // Close settings modal
                    document.getElementById('settingsModal').classList.remove('active');
                    
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Failed to import layout: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // Dashboard Update
        // ============================================
        function updateDashboard(data) {
            portfolioData = data;
            
            // Update KPIs
            const totalValue = document.getElementById('kpi-total-value');
            const totalChange = document.getElementById('kpi-total-change');
            if (totalValue && data.performance.totalValue) {
                totalValue.textContent = formatCurrency(data.performance.totalValue);
                totalChange.textContent = formatCurrency(data.performance.totalGain) + ' (' + formatPercent(data.performance.allTimePercent) + ')';
                totalChange.className = 'kpi-change ' + getChangeClass(data.performance.totalGain);
            }

            const yearlyReturn = document.getElementById('kpi-yearly-return');
            const yearlyGain = document.getElementById('kpi-yearly-gain');
            if (yearlyReturn && data.performance.yearlyPercent2026 !== undefined) {
                yearlyReturn.textContent = formatPercent(data.performance.yearlyPercent2026);
                yearlyGain.textContent = formatCurrency(data.performance.yearlyGain2026);
                yearlyGain.className = 'kpi-change ' + getChangeClass(data.performance.yearlyGain2026);
            }

            const btcAmount = document.getElementById('kpi-btc-amount');
            const btcValue = document.getElementById('kpi-btc-value');
            const btcPrice = document.getElementById('kpi-btc-price');
            if (btcAmount && data.btcCrypto.totalBtcExposure) {
                btcAmount.textContent = formatNumber(data.btcCrypto.totalBtcExposure, 4) + ' BTC';
                btcValue.textContent = formatCurrency(data.btcCrypto.collateralValue);
                btcValue.className = 'kpi-change positive';
                btcPrice.textContent = 'BTC Price: ' + formatCurrency(data.btcCrypto.btcPriceToday, 0);
            }

            const loanRatio = document.getElementById('kpi-loan-ratio');
            const loanStatus = document.getElementById('kpi-loan-status');
            const liqDistance = document.getElementById('kpi-liq-distance');
            if (loanRatio && data.loans.ratio) {
                const ratio = data.loans.ratio;
                loanRatio.textContent = formatPercent(ratio / 100) + ' LTV';
                
                let status, statusClass;
                if (ratio < 50) {
                    status = '‚úÖ Healthy';
                    statusClass = 'positive';
                } else if (ratio < 70) {
                    status = '‚ö†Ô∏è Moderate';
                    statusClass = 'warning';
                } else {
                    status = 'üö® High Risk';
                    statusClass = 'negative';
                }
                loanStatus.textContent = status;
                loanStatus.className = 'kpi-change ' + statusClass;
                
                if (data.loans.dropToLiquidation) {
                    liqDistance.textContent = 'Distance to liquidation: ' + formatPercent(Math.abs(data.loans.dropToLiquidation));
                }
            }

            // Update Performance Diff (Portfolio vs BTC)
            const perfDiff = document.getElementById('kpi-perf-diff');
            const perfDiffStatus = document.getElementById('kpi-perf-diff-status');
            if (perfDiff && data.performance.perfDiffBtcVsPortfolio !== undefined) {
                const diff = data.performance.perfDiffBtcVsPortfolio;
                perfDiff.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(2) + '%';
                
                let status, statusClass;
                if (diff > 0) {
                    status = 'üìà Outperforming BTC';
                    statusClass = 'positive';
                } else if (diff < 0) {
                    status = 'üìâ Underperforming BTC';
                    statusClass = 'negative';
                } else {
                    status = '‚û°Ô∏è Matching BTC';
                    statusClass = '';
                }
                perfDiffStatus.textContent = status;
                perfDiffStatus.className = 'kpi-change ' + statusClass;
            }

            // Update Performance vs S&P 500
            const perfSp500 = document.getElementById('kpi-perf-sp500');
            const perfSp500Status = document.getElementById('kpi-perf-sp500-status');
            if (perfSp500 && data.performance.allTimePercent !== undefined && data.timePassed) {
                // Calculate S&P 500 expected return (avg 10% annually)
                const years = data.timePassed.daysPassed / 365;
                const sp500ExpectedReturn = (Math.pow(1.10, years) - 1) * 100;
                const diffSp500 = data.performance.allTimePercent - sp500ExpectedReturn;
                
                perfSp500.textContent = (diffSp500 >= 0 ? '+' : '') + diffSp500.toFixed(2) + '%';
                
                let statusSp, statusClassSp;
                if (diffSp500 > 0) {
                    statusSp = 'üìà Outperforming S&P';
                    statusClassSp = 'positive';
                } else if (diffSp500 < 0) {
                    statusSp = 'üìâ Underperforming S&P';
                    statusClassSp = 'negative';
                } else {
                    statusSp = '‚û°Ô∏è Matching S&P';
                    statusClassSp = '';
                }
                perfSp500Status.textContent = statusSp;
                perfSp500Status.className = 'kpi-change ' + statusClassSp;
            }

            // Update Daily Average (2026)
            const dailyAvg2026 = document.getElementById('kpi-daily-avg-2026');
            if (dailyAvg2026 && data.performance.dailyAvg2026 !== undefined) {
                dailyAvg2026.textContent = formatCurrency(data.performance.dailyAvg2026);
                dailyAvg2026.className = 'kpi-value sensitive-data ' + getChangeClass(data.performance.dailyAvg2026);
            }

            // Update Daily Average (All-time)
            const dailyAvgAlltime = document.getElementById('kpi-daily-avg-alltime');
            if (dailyAvgAlltime && data.performance.dailyAvg !== undefined) {
                dailyAvgAlltime.textContent = formatCurrency(data.performance.dailyAvg);
                dailyAvgAlltime.className = 'kpi-value sensitive-data ' + getChangeClass(data.performance.dailyAvg);
            }

            // Update Monthly Average (2026)
            const monthlyAvg2026 = document.getElementById('kpi-monthly-avg-2026');
            if (monthlyAvg2026 && data.performance.monthlyAvg2026 !== undefined) {
                monthlyAvg2026.textContent = formatCurrency(data.performance.monthlyAvg2026);
                monthlyAvg2026.className = 'kpi-value sensitive-data ' + getChangeClass(data.performance.monthlyAvg2026);
            }

            // Update Monthly Average (All-time)
            const monthlyAvgAlltime = document.getElementById('kpi-monthly-avg-alltime');
            if (monthlyAvgAlltime && data.performance.monthlyAvg !== undefined) {
                monthlyAvgAlltime.textContent = formatCurrency(data.performance.monthlyAvg);
                monthlyAvgAlltime.className = 'kpi-value sensitive-data ' + getChangeClass(data.performance.monthlyAvg);
            }

            // Update Split Portfolio
            const splitTotal = document.getElementById('kpi-split-total');
            const splitHalf = document.getElementById('kpi-split-half');
            if (splitTotal && data.splitPortfolio) {
                splitTotal.textContent = formatCurrency(data.splitPortfolio.totalValue);
                splitHalf.textContent = 'Your half: ' + formatCurrency(data.splitPortfolio.halfValue);
                splitHalf.className = 'kpi-change positive';
            }

            // Update CAGR (Compound Annual Growth Rate)
            const cagrEl = document.getElementById('kpi-cagr');
            const cagrYears = document.getElementById('kpi-cagr-years');
            if (cagrEl && data.performance.totalValue && data.performance.totalGain && data.timePassed) {
                const startValue = data.performance.totalValue - data.performance.totalGain;
                const endValue = data.performance.totalValue;
                const years = data.timePassed.daysPassed / 365;
                
                if (startValue > 0 && years > 0) {
                    const cagr = (Math.pow(endValue / startValue, 1 / years) - 1) * 100;
                    cagrEl.textContent = formatPercent(cagr);
                    cagrEl.className = 'kpi-value ' + getChangeClass(cagr);
                    cagrYears.textContent = `Over ${years.toFixed(1)} years`;
                }
            }

            // Update Debt-to-Asset Ratio
            const debtRatioEl = document.getElementById('kpi-debt-ratio');
            const debtDetailsEl = document.getElementById('kpi-debt-details');
            if (debtRatioEl && data.loans && data.performance.totalValue) {
                const debt = Math.abs(data.loans.borrowed || 0);
                const totalAssets = data.performance.totalValue;
                const ratio = (debt / totalAssets) * 100;
                
                debtRatioEl.textContent = formatPercent(ratio);
                debtDetailsEl.textContent = formatCurrency(debt) + ' / ' + formatCurrency(totalAssets);
                
                // Color based on risk level
                let ratioClass = 'positive';
                if (ratio > 70) ratioClass = 'negative';
                else if (ratio > 50) ratioClass = 'warning';
                debtRatioEl.className = 'kpi-value sensitive-data ' + ratioClass;
            }

            // Update Net Worth Velocity
            const nwVelocityEl = document.getElementById('kpi-nw-velocity');
            const nwMonthlyEl = document.getElementById('kpi-nw-monthly');
            if (nwVelocityEl && data.performance) {
                // Net worth = Total assets - Debt
                const debt = Math.abs(data.loans?.borrowed || 0);
                const netWorth = data.performance.totalValue - debt;
                
                // Velocity = rate of change (monthly average profit * 12 for yearly)
                const monthlyVelocity = data.performance.monthlyAvg || 0;
                const yearlyVelocity = monthlyVelocity * 12;
                
                nwVelocityEl.textContent = formatCurrency(yearlyVelocity) + '/yr';
                nwVelocityEl.className = 'kpi-value sensitive-data ' + getChangeClass(yearlyVelocity);
                nwMonthlyEl.textContent = formatCurrency(monthlyVelocity) + '/mo ‚Ä¢ Net: ' + formatCurrency(netWorth);
                nwMonthlyEl.className = 'kpi-change sensitive-data';
            }

            // Update Goals
            console.log('Goals data before update:', data.goals);
            updateGoals(data.goals);
            
            // Update Loan Details
            updateLoanDetails(data.loans);
            
            // Update FIRE section
            updateFireSection(data.fire, data.timePassed);

            // Update new advanced widgets
            updateMonteCarloWidget(data);
            updateInflationWidget(data);
            updateMilestoneWidget(data);
            updateRiskWidget(data);
            
            // Store data globally for peer settings modal refresh
            window.currentDashboardData = data;
            updatePeerBenchmarkWidget(data);

            // Update Charts - slight delay to ensure DOM is ready
            setTimeout(() => updateCharts(data), 50);

            // Update timestamp
            document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
        }

        // ============================================
        // Monte Carlo Simulation Widget (Enhanced)
        // ============================================
        // Features:
        // - Multiple FIRE checkpoints: $250k, $500k, $750k, $1M
        // - Crypto-appropriate volatility: 10% monthly (8-12% range)
        // - Multiple time horizons: 1, 2, 5, 10 years
        // - Percentiles: 5th, 15th, 45th, 85th
        // ============================================
        function updateMonteCarloWidget(data) {
            const container = document.getElementById('monte-carlo-container');
            if (!container) return;
            
            if (!data.performance) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 1rem;">Insufficient data for simulation</div>';
                return;
            }
            
            // Monte Carlo parameters
            const currentValue = data.performance.totalValue || 0;
            const monthlyContribution = data.performance.monthlyAvg || 0; // All-time average
            const simulations = 1000;
            
            // FIRE target checkpoints
            const targets = [
                { name: '$250K', value: 250000 },
                { name: '$500K', value: 500000 },
                { name: '$750K', value: 750000 },
                { name: '$1M', value: 1000000 }
            ];
            
            // Time horizons in years
            const horizons = [1, 2, 5, 10];
            
            // Percentiles to calculate
            const percentiles = [0.05, 0.15, 0.45, 0.85];
            const percentileLabels = ['5th', '15th', '45th', '85th'];
            const percentileColors = ['var(--accent-red)', 'var(--accent-yellow)', 'var(--accent-blue)', 'var(--accent-green)'];
            
            // Historical return assumptions
            const meanReturn = (data.performance.allTimePercent || 10) / 100 / 12; // Monthly
            const volatility = 0.10; // 10% monthly volatility for crypto (middle of 8-12% range)
            
            // Run simulations and track values at each horizon + milestone hits
            const horizonResults = {}; // { years: [finalValues] }
            const milestoneResults = {}; // { targetValue: [yearsToReach or null] }
            
            horizons.forEach(h => horizonResults[h] = []);
            targets.forEach(t => milestoneResults[t.value] = []);
            
            for (let sim = 0; sim < simulations; sim++) {
                let value = currentValue;
                const milestonesHit = {}; // Track when each milestone is hit
                targets.forEach(t => milestonesHit[t.value] = null);
                
                const maxMonths = Math.max(...horizons) * 12;
                
                for (let month = 1; month <= maxMonths; month++) {
                    // Random return using Box-Muller transform (normal distribution)
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    const monthlyReturn = meanReturn + z * volatility;
                    
                    value = value * (1 + monthlyReturn) + monthlyContribution;
                    
                    // Check milestone hits
                    targets.forEach(t => {
                        if (value >= t.value && milestonesHit[t.value] === null) {
                            milestonesHit[t.value] = month / 12;
                        }
                    });
                    
                    // Record values at each horizon
                    const yearMark = month / 12;
                    if (horizons.includes(yearMark)) {
                        horizonResults[yearMark].push(value);
                    }
                }
                
                // Store milestone results
                targets.forEach(t => {
                    milestoneResults[t.value].push(milestonesHit[t.value]);
                });
            }
            
            // Calculate percentile values for each horizon
            const getPercentile = (arr, p) => {
                const sorted = [...arr].sort((a, b) => a - b);
                return sorted[Math.floor(sorted.length * p)] || 0;
            };
            
            // Calculate probability of hitting each target within 10 years
            const targetProbabilities = targets.map(t => {
                const hits = milestoneResults[t.value].filter(y => y !== null).length;
                return Math.round((hits / simulations) * 100);
            });
            
            // Calculate median time to each target (for those that hit it)
            const medianTimeToTarget = targets.map(t => {
                const hits = milestoneResults[t.value].filter(y => y !== null).sort((a, b) => a - b);
                if (hits.length === 0) return null;
                return hits[Math.floor(hits.length / 2)];
            });
            
            // Build the widget HTML
            let html = '';
            
            // Section 1: Percentile projections by horizon
            html += `<div style="margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; text-align: center; font-weight: 500;">
                    Portfolio Value by Time Horizon
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="padding: 8px 6px; text-align: left; color: var(--text-secondary); font-size: 12px;">Horizon</th>
                                ${percentileLabels.map((label, i) => 
                                    `<th style="padding: 8px 6px; text-align: right; color: ${percentileColors[i]}; font-size: 12px;">${label}</th>`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${horizons.map(h => `
                                <tr style="border-bottom: 1px solid var(--bg-secondary);">
                                    <td style="padding: 8px 6px; color: var(--text-primary); font-weight: 600;">${h}Y</td>
                                    ${percentiles.map((p, i) => {
                                        const val = getPercentile(horizonResults[h], p);
                                        return `<td style="padding: 8px 6px; text-align: right; color: ${percentileColors[i]}; font-variant-numeric: tabular-nums;">${formatCurrency(val, 0)}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
            
            // Section 2: FIRE milestone probabilities
            html += `<div style="margin-bottom: 12px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; text-align: center; font-weight: 500;">
                    Probability of Reaching Milestones (10Y)
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                    ${targets.map((t, i) => {
                        const prob = targetProbabilities[i];
                        const medianYrs = medianTimeToTarget[i];
                        const probColor = prob >= 75 ? 'var(--accent-green)' : prob >= 50 ? 'var(--accent-blue)' : prob >= 25 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                        return `
                            <div style="text-align: center; padding: 10px 6px; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${t.name}</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${probColor};">${prob}%</div>
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">${medianYrs ? medianYrs.toFixed(1) + 'y med' : '>10y'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>`;
            
            // Section 3: Simulation parameters
            html += `<div style="text-align: center; font-size: 11px; color: var(--text-tertiary); padding-top: 10px; border-top: 1px solid var(--border-color);">
                ${simulations.toLocaleString()} sims ‚Ä¢ ${(volatility * 100).toFixed(0)}% vol ‚Ä¢ ${formatCurrency(monthlyContribution, 0)}/mo contrib
            </div>`;
            
            container.innerHTML = html;
        }

        // ============================================
        // Inflation-Adjusted Returns Widget
        // ============================================
        let currentInflationRate = parseFloat(localStorage.getItem('zhodler-inflation-rate')) || 0.03;
        
        function updateInflationWidget(data) {
            const container = document.getElementById('inflation-container');
            if (!container) return;
            
            if (!data.performance) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">No data</div>';
                return;
            }
            
            const inflationRate = currentInflationRate;
            const years = data.timePassed ? data.timePassed.daysPassed / 365 : 1;
            
            const nominalReturn = data.performance.allTimePercent || 0;
            const inflationFactor = Math.pow(1 + inflationRate, years);
            const realReturn = ((1 + nominalReturn / 100) / inflationFactor - 1) * 100;
            
            const nominalGain = data.performance.totalGain || 0;
            const realGain = nominalGain / inflationFactor;
            
            const purchasingPowerLoss = nominalGain - realGain;
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                    <span style="font-size: 13px; color: var(--text-secondary);">Inflation:</span>
                    <input type="range" id="inflation-slider" min="0" max="15" step="0.5" value="${(inflationRate * 100).toFixed(1)}" 
                        style="flex: 1; height: 6px; cursor: pointer; accent-color: var(--accent-green);">
                    <span id="inflation-rate-display" style="font-size: 14px; font-weight: 600; min-width: 45px; text-align: right;">${(inflationRate * 100).toFixed(1)}%</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-secondary);">Nominal Return</span>
                        <span style="color: var(--accent-green); font-weight: 600;">${formatPercent(nominalReturn)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-secondary);">Real Return</span>
                        <span style="color: ${realReturn > 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${formatPercent(realReturn)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-secondary);">Nominal Gain</span>
                        <span style="font-weight: 600;">${formatCurrency(nominalGain)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: var(--text-secondary);">Real Gain</span>
                        <span style="font-weight: 600;">${formatCurrency(realGain)}</span>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: var(--text-tertiary); text-align: center;">
                    Lost to inflation: ${formatCurrency(purchasingPowerLoss)} over ${years.toFixed(1)} years
                </div>
            `;
            
            // Add event listener for slider
            const slider = document.getElementById('inflation-slider');
            const display = document.getElementById('inflation-rate-display');
            if (slider) {
                slider.addEventListener('input', (e) => {
                    const newRate = parseFloat(e.target.value) / 100;
                    currentInflationRate = newRate;
                    localStorage.setItem('zhodler-inflation-rate', newRate.toString());
                    display.textContent = e.target.value + '%';
                    
                    // Recalculate and update values without full redraw
                    const newInflationFactor = Math.pow(1 + newRate, years);
                    const newRealReturn = ((1 + nominalReturn / 100) / newInflationFactor - 1) * 100;
                    const newRealGain = nominalGain / newInflationFactor;
                    const newPurchasingPowerLoss = nominalGain - newRealGain;
                    
                    // Update display values
                    updateInflationWidget(data);
                });
            }
        }

        // ============================================
        // Milestone Timeline Widget
        // ============================================
        function updateMilestoneWidget(data) {
            const container = document.getElementById('milestone-container');
            if (!container) return;
            
            const milestones = [
                { name: '$50K', target: 50000, icon: 'üéØ' },
                { name: '$75K', target: 75000, icon: 'üìà' },
                { name: '$100K', target: 100000, icon: 'üíØ' },
                { name: '$150K', target: 150000, icon: 'üöÄ' },
                { name: '$250K', target: 250000, icon: '‚≠ê' },
                { name: '$500K', target: 500000, icon: 'üíé' },
                { name: '$1M', target: 1000000, icon: 'üèÜ' }
            ];
            
            const currentValue = data.performance?.totalValue || 0;
            const monthlyGrowth = data.performance?.monthlyAvg || 0;
            
            let html = '<div style="position: relative; padding: 20px 0 10px 0;">';
            
            // Progress line - positioned in middle of icon area
            const maxTarget = milestones[milestones.length - 1].target;
            const progress = Math.min(100, (currentValue / maxTarget) * 100);
            
            html += `<div style="position: absolute; top: 34px; left: 20px; right: 20px; height: 6px; background: var(--bg-secondary); border-radius: 3px;"></div>`;
            html += `<div style="position: absolute; top: 34px; left: 20px; width: calc(${progress}% - 20px); height: 6px; background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); border-radius: 3px;"></div>`;
            
            // Milestone markers
            html += '<div style="display: flex; justify-content: space-between; position: relative; z-index: 1;">';
            
            milestones.forEach(m => {
                const achieved = currentValue >= m.target;
                const position = (m.target / maxTarget) * 100;
                const monthsToReach = achieved ? 0 : Math.ceil((m.target - currentValue) / monthlyGrowth);
                const timeLabel = achieved ? '‚úì' : (monthsToReach > 0 ? `${monthsToReach}mo` : '--');
                
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; width: 48px;">
                        <div style="width: 28px; height: 28px; border-radius: 50%; background: ${achieved ? 'var(--accent-green)' : 'var(--bg-secondary)'}; border: 2px solid ${achieved ? 'var(--accent-green)' : 'var(--border-color)'}; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                            ${achieved ? '‚úì' : m.icon}
                        </div>
                        <div style="font-size: 12px; color: ${achieved ? 'var(--accent-green)' : 'var(--text-secondary)'}; margin-top: 10px; font-weight: ${achieved ? '600' : '400'};">${m.name}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">${timeLabel}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            // Current position indicator
            html += `<div style="text-align: center; margin-top: 12px; font-size: 13px; color: var(--text-secondary);">Current: ${formatCurrency(currentValue, 0)} (${progress.toFixed(1)}% to $1M)</div>`;
            
            container.innerHTML = html;
        }

        // ============================================
        // Risk Dashboard Widget (Enhanced)
        // ============================================
        // Features:
        // - Real volatility calculated from yearly returns
        // - Real beta calculated from portfolio vs BTC correlation
        // - Sharpe Ratio (risk-adjusted returns)
        // - Value at Risk (VaR) at 95% confidence
        // - Liquidation risk from Compound position
        // ============================================
        function updateRiskWidget(data) {
            const container = document.getElementById('risk-container');
            if (!container) return;
            
            const totalValue = data.performance?.totalValue || 1;
            const riskFreeRate = 0.05; // 5% risk-free rate assumption (T-bills)
            
            // ==========================================
            // 1. CONCENTRATION RISK (from asset distribution)
            // ==========================================
            let maxConcentration = 0;
            let largestAsset = 'N/A';
            let top3Concentration = 0;
            
            if (data.assetDistro && data.assetDistro.length > 0) {
                const sorted = [...data.assetDistro].sort((a, b) => b.value - a.value);
                if (sorted[0]) {
                    maxConcentration = (sorted[0].value / totalValue) * 100;
                    largestAsset = sorted[0].asset;
                }
                // Top 3 concentration
                const top3Value = sorted.slice(0, 3).reduce((sum, a) => sum + (a.value || 0), 0);
                top3Concentration = (top3Value / totalValue) * 100;
            }
            
            // ==========================================
            // 2. REAL VOLATILITY (from yearly returns)
            // ==========================================
            let annualVolatility = 50; // Default fallback for crypto
            let portfolioReturns = [];
            let btcReturns = [];
            
            if (data.performance?.yearly && data.performance.yearly.length >= 2) {
                // Extract yearly returns
                portfolioReturns = data.performance.yearly
                    .filter(y => y.percent !== null && !isNaN(y.percent))
                    .map(y => y.percent / 100);
                
                btcReturns = data.performance.yearly
                    .filter(y => y.btc !== null && !isNaN(y.btc))
                    .map(y => y.btc / 100);
                
                if (portfolioReturns.length >= 2) {
                    // Calculate standard deviation of returns
                    const mean = portfolioReturns.reduce((a, b) => a + b, 0) / portfolioReturns.length;
                    const squaredDiffs = portfolioReturns.map(r => Math.pow(r - mean, 2));
                    const variance = squaredDiffs.reduce((a, b) => a + b, 0) / (portfolioReturns.length - 1);
                    annualVolatility = Math.sqrt(variance) * 100;
                }
            }
            
            // ==========================================
            // 3. REAL BETA (portfolio vs BTC correlation)
            // ==========================================
            let beta = 1.0; // Default: moves with BTC
            let correlation = 0;
            
            if (portfolioReturns.length >= 2 && btcReturns.length >= 2 && portfolioReturns.length === btcReturns.length) {
                const n = portfolioReturns.length;
                const meanP = portfolioReturns.reduce((a, b) => a + b, 0) / n;
                const meanB = btcReturns.reduce((a, b) => a + b, 0) / n;
                
                let covariance = 0;
                let varP = 0;
                let varB = 0;
                
                for (let i = 0; i < n; i++) {
                    const diffP = portfolioReturns[i] - meanP;
                    const diffB = btcReturns[i] - meanB;
                    covariance += diffP * diffB;
                    varP += diffP * diffP;
                    varB += diffB * diffB;
                }
                
                covariance /= (n - 1);
                varP /= (n - 1);
                varB /= (n - 1);
                
                if (varB > 0) {
                    beta = covariance / varB;
                }
                
                // Correlation coefficient
                if (varP > 0 && varB > 0) {
                    correlation = covariance / (Math.sqrt(varP) * Math.sqrt(varB));
                }
            }
            
            // ==========================================
            // 4. SHARPE RATIO (risk-adjusted returns)
            // ==========================================
            const avgAnnualReturn = (data.performance?.allTimePercent || 0) / 100;
            const yearsInvested = data.timePassed?.years || 1;
            const annualizedReturn = data.performance?.allTimeCompound || avgAnnualReturn;
            const sharpeRatio = annualVolatility > 0 
                ? ((annualizedReturn / 100) - riskFreeRate) / (annualVolatility / 100) 
                : 0;
            
            // ==========================================
            // 5. VALUE AT RISK (VaR) - 95% confidence
            // ==========================================
            // VaR = Portfolio Value √ó (Mean Return - Z √ó Volatility)
            // Z = 1.645 for 95% confidence (one-tailed)
            const zScore95 = 1.645;
            const dailyVolatility = annualVolatility / Math.sqrt(252); // Convert to daily
            const dailyVaR = totalValue * (zScore95 * dailyVolatility / 100);
            const monthlyVaR = totalValue * (zScore95 * (annualVolatility / Math.sqrt(12)) / 100);
            
            // ==========================================
            // 6. LIQUIDATION RISK (Compound position)
            // ==========================================
            const currentLTV = data.loans?.ratio || 0;
            const dropToLiquidation = data.loans?.dropToLiquidation || 100;
            const liquidationPrice = data.loans?.liquidationPrice || 0;
            const collateralValue = data.loans?.collateralValue || 0;
            const borrowed = Math.abs(data.loans?.borrowed || 0);
            
            // Liquidation risk score (0-100)
            // Higher LTV = higher risk, lower drop to liquidation = higher risk
            let liquidationRisk = 0;
            if (currentLTV > 0) {
                // LTV contribution (0-50 points): 80% LTV = 50 points
                liquidationRisk += Math.min(50, (currentLTV / 80) * 50);
                // Drop to liquidation contribution (0-50 points): 20% drop = 50 points
                liquidationRisk += Math.min(50, ((100 - dropToLiquidation) / 80) * 50);
            }
            
            // ==========================================
            // 7. DEBT RATIO
            // ==========================================
            const debtRatio = borrowed > 0 ? (borrowed / totalValue) * 100 : 0;
            
            // ==========================================
            // OVERALL RISK SCORE
            // ==========================================
            // Weighted components
            const concentrationScore = Math.min(100, maxConcentration);
            const volatilityScore = Math.min(100, annualVolatility);
            const debtScore = Math.min(100, debtRatio * 1.5);
            const liqScore = Math.min(100, liquidationRisk);
            
            const overallRisk = (
                concentrationScore * 0.20 +  // 20% weight
                volatilityScore * 0.25 +     // 25% weight
                debtScore * 0.20 +           // 20% weight
                liqScore * 0.20 +            // 20% weight
                (100 - Math.min(100, sharpeRatio * 25)) * 0.15  // 15% weight (inverse - higher Sharpe = lower risk)
            );
            
            // ==========================================
            // HELPER FUNCTIONS
            // ==========================================
            const getRiskColor = (score, invert = false) => {
                const s = invert ? 100 - score : score;
                if (s < 30) return 'var(--accent-green)';
                if (s < 60) return 'var(--accent-yellow)';
                return 'var(--accent-red)';
            };
            
            const getRiskLabel = (score) => {
                if (score < 30) return 'Low';
                if (score < 60) return 'Moderate';
                return 'High';
            };
            
            const getSharpeLabel = (s) => {
                if (s >= 2) return 'Excellent';
                if (s >= 1) return 'Good';
                if (s >= 0.5) return 'Acceptable';
                if (s >= 0) return 'Poor';
                return 'Negative';
            };
            
            const getSharpeColor = (s) => {
                if (s >= 2) return 'var(--accent-green)';
                if (s >= 1) return 'var(--accent-blue)';
                if (s >= 0.5) return 'var(--accent-yellow)';
                return 'var(--accent-red)';
            };
            
            // ==========================================
            // BUILD HTML
            // ==========================================
            let html = '';
            
            // Row 1: Core risk metrics (2x3 grid)
            html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                        Concentration
                        <span class="info-icon" onclick="showTooltip(event, riskTooltips.concentration.title, riskTooltips.concentration.content)">i</span>
                    </div>
                    <div style="color: ${getRiskColor(concentrationScore)}; font-weight: 700; font-size: 18px;">${maxConcentration.toFixed(0)}%</div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">${largestAsset}</div>
                </div>
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                        Volatility
                        <span class="info-icon" onclick="showTooltip(event, riskTooltips.volatility.title, riskTooltips.volatility.content)">i</span>
                    </div>
                    <div style="color: ${getRiskColor(volatilityScore)}; font-weight: 700; font-size: 18px;">${annualVolatility.toFixed(0)}%</div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Annual œÉ</div>
                </div>
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                        Beta (BTC)
                        <span class="info-icon" onclick="showTooltip(event, riskTooltips.beta.title, riskTooltips.beta.content)">i</span>
                    </div>
                    <div style="font-weight: 700; font-size: 18px; color: ${beta > 1.2 ? 'var(--accent-red)' : beta < 0.8 ? 'var(--accent-green)' : 'var(--accent-blue)'};">${beta.toFixed(2)}</div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">r=${correlation.toFixed(2)}</div>
                </div>
            </div>`;
            
            // Row 2: Advanced metrics (2 columns without Max Drawdown)
            html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                        Sharpe Ratio
                        <span class="info-icon" onclick="showTooltip(event, riskTooltips.sharpe.title, riskTooltips.sharpe.content)">i</span>
                    </div>
                    <div style="color: ${getSharpeColor(sharpeRatio)}; font-weight: 700; font-size: 18px;">${sharpeRatio.toFixed(2)}</div>
                    <div style="font-size: 11px; color: ${getSharpeColor(sharpeRatio)}; margin-top: 2px;">${getSharpeLabel(sharpeRatio)}</div>
                </div>
                <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                        Daily VaR 95%
                        <span class="info-icon" onclick="showTooltip(event, riskTooltips.var.title, riskTooltips.var.content)">i</span>
                    </div>
                    <div style="color: var(--accent-red); font-weight: 700; font-size: 18px;">${formatCurrency(dailyVaR, 0)}</div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">At risk</div>
                </div>
            </div>`;
            
            // Row 3: Liquidation risk (if applicable)
            if (borrowed > 0) {
                html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                        <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                            Leverage
                            <span class="info-icon" onclick="showTooltip(event, riskTooltips.leverage.title, riskTooltips.leverage.content)">i</span>
                        </div>
                        <div style="color: ${getRiskColor(debtScore)}; font-weight: 700; font-size: 18px;">${debtRatio.toFixed(0)}%</div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Debt ratio</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                        <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                            Current LTV
                            <span class="info-icon" onclick="showTooltip(event, riskTooltips.ltv.title, riskTooltips.ltv.content)">i</span>
                        </div>
                        <div style="color: ${currentLTV > 70 ? 'var(--accent-red)' : currentLTV > 50 ? 'var(--accent-yellow)' : 'var(--accent-green)'}; font-weight: 700; font-size: 18px;">${currentLTV.toFixed(0)}%</div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Compound</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; text-align: center; position: relative;">
                        <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">
                            Liq. Buffer
                            <span class="info-icon" onclick="showTooltip(event, riskTooltips.liqBuffer.title, riskTooltips.liqBuffer.content)">i</span>
                        </div>
                        <div style="color: ${dropToLiquidation < 30 ? 'var(--accent-red)' : dropToLiquidation < 50 ? 'var(--accent-yellow)' : 'var(--accent-green)'}; font-weight: 700; font-size: 18px;">-${dropToLiquidation.toFixed(0)}%</div>
                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">${formatCurrency(liquidationPrice, 0)}</div>
                    </div>
                </div>`;
            }
            
            // Overall Risk Score
            html += `<div style="padding: 12px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-radius: 10px; text-align: center; border: 1px solid ${getRiskColor(overallRisk)}40;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">
                            Overall Risk
                            <span class="info-icon" onclick="showTooltip(event, riskTooltips.overall.title, riskTooltips.overall.content)">i</span>
                        </div>
                        <div style="font-size: 22px; font-weight: 700; color: ${getRiskColor(overallRisk)};">${overallRisk.toFixed(0)}/100</div>
                    </div>
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 16px; font-weight: 600; color: ${getRiskColor(overallRisk)};">${getRiskLabel(overallRisk)} Risk</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">
                            Monthly VaR
                            <span class="info-icon" onclick="showTooltip(event, riskTooltips.monthlyVar.title, riskTooltips.monthlyVar.content)">i</span>
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--accent-red);">${formatCurrency(monthlyVaR, 0)}</div>
                    </div>
                </div>
            </div>`;
            
            // Data source note
            const dataYears = portfolioReturns.length;
            html += `<div style="text-align: center; font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                ${dataYears > 0 ? `Calculated from ${dataYears} years of data` : 'Using estimated values'} ‚Ä¢ ${riskFreeRate * 100}% risk-free rate
            </div>`;
            
            container.innerHTML = html;
        }

        // ============================================
        // Peer Benchmarking Widget (Enhanced)
        // ============================================
        // Features:
        // - Configurable age (default 47)
        // - Real peer data from Federal Reserve SCF 2022, ECB HFCS, UBS Global Wealth
        // - Income-based comparison (configurable)
        // - Adjustable net worth (include other assets)
        // - Country/region selection (US, Europe, Asia, Portugal, Japan, China)
        // - Real percentile calculation using linear interpolation
        // ============================================
        
        // Peer benchmark configuration (from SettingsManager)
        let peerConfig = SettingsManager.current?.peer || {
            age: 47,
            region: 'US',
            income: 75000,
            otherAssets: 0,
            currency: 'USD'
        };
        
        // Comprehensive peer data by region and age
        // Sources: Federal Reserve SCF 2022, ECB HFCS 2021, UBS Global Wealth Report 2024
        // All values in USD for comparison (converted at approximate rates)
        const peerDataByRegion = {
            'US': {
                name: 'United States',
                currency: 'USD',
                source: 'Federal Reserve SCF 2022',
                // Age groups: percentile thresholds [p10, p25, p50, p75, p90, p95, p99]
                byAge: {
                    '18-24': { p10: 0, p25: 500, p50: 10800, p75: 45000, p90: 120000, p95: 200000, p99: 500000 },
                    '25-34': { p10: 0, p25: 6700, p50: 39000, p75: 135000, p90: 340000, p95: 550000, p99: 1400000 },
                    '35-44': { p10: 1000, p25: 27000, p50: 135000, p75: 380000, p90: 850000, p95: 1400000, p99: 4000000 },
                    '45-54': { p10: 3000, p25: 52000, p50: 247000, p75: 650000, p90: 1500000, p95: 2500000, p99: 7000000 },
                    '55-64': { p10: 6500, p25: 75000, p50: 364000, p75: 950000, p90: 2100000, p95: 3500000, p99: 10000000 },
                    '65-74': { p10: 10000, p25: 95000, p50: 410000, p75: 1050000, p90: 2400000, p95: 4000000, p99: 12000000 },
                    '75+': { p10: 8000, p25: 80000, p50: 335000, p75: 850000, p90: 1900000, p95: 3200000, p99: 9500000 }
                },
                // Income quintiles multipliers (adjust percentiles based on income)
                byIncome: {
                    '<25k': 0.25,      // Bottom 20%
                    '25k-50k': 0.50,   // 20-40%
                    '50k-100k': 1.0,   // 40-60% (baseline)
                    '100k-200k': 1.8,  // 60-80%
                    '>200k': 3.5       // Top 20%
                }
            },
            'Europe': {
                name: 'Euro Area',
                currency: 'EUR',
                source: 'ECB HFCS 2021',
                // Converted to USD at ~1.10 rate
                byAge: {
                    '18-24': { p10: 0, p25: 1000, p50: 8000, p75: 35000, p90: 90000, p95: 150000, p99: 400000 },
                    '25-34': { p10: 500, p25: 8000, p50: 45000, p75: 120000, p90: 280000, p95: 450000, p99: 1100000 },
                    '35-44': { p10: 3000, p25: 35000, p50: 120000, p75: 300000, p90: 650000, p95: 1000000, p99: 2800000 },
                    '45-54': { p10: 8000, p25: 65000, p50: 200000, p75: 480000, p90: 1000000, p95: 1600000, p99: 4500000 },
                    '55-64': { p10: 15000, p25: 95000, p50: 280000, p75: 620000, p90: 1300000, p95: 2100000, p99: 6000000 },
                    '65-74': { p10: 20000, p25: 110000, p50: 300000, p75: 650000, p90: 1400000, p95: 2300000, p99: 6500000 },
                    '75+': { p10: 15000, p25: 90000, p50: 250000, p75: 550000, p90: 1150000, p95: 1900000, p99: 5500000 }
                },
                byIncome: {
                    '<20k': 0.30,
                    '20k-40k': 0.55,
                    '40k-80k': 1.0,
                    '80k-150k': 1.7,
                    '>150k': 3.0
                }
            },
            'Portugal': {
                name: 'Portugal',
                currency: 'EUR',
                source: 'Banco de Portugal ISFF 2020',
                // Portuguese wealth is ~30% below Euro area median (converted to USD)
                byAge: {
                    '18-24': { p10: 0, p25: 500, p50: 5000, p75: 25000, p90: 65000, p95: 110000, p99: 300000 },
                    '25-34': { p10: 0, p25: 5000, p50: 32000, p75: 85000, p90: 200000, p95: 320000, p99: 800000 },
                    '35-44': { p10: 2000, p25: 25000, p50: 85000, p75: 210000, p90: 460000, p95: 720000, p99: 2000000 },
                    '45-54': { p10: 5000, p25: 45000, p50: 140000, p75: 340000, p90: 720000, p95: 1150000, p99: 3200000 },
                    '55-64': { p10: 10000, p25: 65000, p50: 200000, p75: 440000, p90: 920000, p95: 1500000, p99: 4200000 },
                    '65-74': { p10: 12000, p25: 75000, p50: 210000, p75: 460000, p90: 980000, p95: 1600000, p99: 4500000 },
                    '75+': { p10: 10000, p25: 60000, p50: 175000, p75: 380000, p90: 800000, p95: 1300000, p99: 3800000 }
                },
                byIncome: {
                    '<15k': 0.35,
                    '15k-30k': 0.60,
                    '30k-60k': 1.0,
                    '60k-100k': 1.6,
                    '>100k': 2.8
                }
            },
            'Japan': {
                name: 'Japan',
                currency: 'JPY',
                source: 'Japan Household Survey 2024',
                // Converted to USD at ~150 JPY/USD
                byAge: {
                    '18-24': { p10: 0, p25: 1000, p50: 6000, p75: 20000, p90: 50000, p95: 85000, p99: 220000 },
                    '25-34': { p10: 0, p25: 3000, p50: 18000, p75: 55000, p90: 130000, p95: 210000, p99: 550000 },
                    '35-44': { p10: 1000, p25: 12000, p50: 55000, p75: 150000, p90: 350000, p95: 560000, p99: 1500000 },
                    '45-54': { p10: 3000, p25: 25000, p50: 100000, p75: 270000, p90: 600000, p95: 950000, p99: 2600000 },
                    '55-64': { p10: 8000, p25: 45000, p50: 170000, p75: 420000, p90: 900000, p95: 1450000, p99: 4000000 },
                    '65-74': { p10: 15000, p25: 70000, p50: 220000, p75: 520000, p90: 1100000, p95: 1750000, p99: 4800000 },
                    '75+': { p10: 12000, p25: 55000, p50: 180000, p75: 430000, p90: 900000, p95: 1450000, p99: 4000000 }
                },
                byIncome: {
                    '<3M': 0.30,       // <$20k
                    '3M-6M': 0.55,     // $20k-40k
                    '6M-12M': 1.0,     // $40k-80k
                    '12M-20M': 1.6,    // $80k-133k
                    '>20M': 2.8        // >$133k
                }
            },
            'China': {
                name: 'China',
                currency: 'CNY',
                source: 'China Household Finance Survey 2020',
                // Converted to USD at ~7.2 CNY/USD, urban households
                byAge: {
                    '18-24': { p10: 0, p25: 500, p50: 3000, p75: 12000, p90: 35000, p95: 60000, p99: 160000 },
                    '25-34': { p10: 0, p25: 2000, p50: 12000, p75: 40000, p90: 100000, p95: 165000, p99: 430000 },
                    '35-44': { p10: 1000, p25: 8000, p50: 38000, p75: 110000, p90: 260000, p95: 420000, p99: 1150000 },
                    '45-54': { p10: 2000, p25: 17000, p50: 70000, p75: 190000, p90: 430000, p95: 700000, p99: 1900000 },
                    '55-64': { p10: 4000, p25: 28000, p50: 100000, p75: 260000, p90: 580000, p95: 940000, p99: 2600000 },
                    '65-74': { p10: 5000, p25: 35000, p50: 115000, p75: 290000, p90: 640000, p95: 1040000, p99: 2850000 },
                    '75+': { p10: 4000, p25: 28000, p50: 95000, p75: 240000, p90: 530000, p95: 860000, p99: 2350000 }
                },
                byIncome: {
                    '<50k': 0.25,      // <$7k
                    '50k-150k': 0.50,  // $7k-21k
                    '150k-300k': 1.0,  // $21k-42k
                    '300k-600k': 1.8,  // $42k-83k
                    '>600k': 3.5       // >$83k
                }
            },
            'Asia': {
                name: 'Asia (Developed)',
                currency: 'USD',
                source: 'UBS Global Wealth 2024 (Singapore, HK, Taiwan avg)',
                byAge: {
                    '18-24': { p10: 0, p25: 2000, p50: 12000, p75: 45000, p90: 110000, p95: 180000, p99: 470000 },
                    '25-34': { p10: 1000, p25: 10000, p50: 50000, p75: 150000, p90: 360000, p95: 580000, p99: 1500000 },
                    '35-44': { p10: 5000, p25: 40000, p50: 160000, p75: 420000, p90: 950000, p95: 1550000, p99: 4200000 },
                    '45-54': { p10: 15000, p25: 80000, p50: 300000, p75: 750000, p90: 1650000, p95: 2700000, p99: 7400000 },
                    '55-64': { p10: 25000, p25: 130000, p50: 450000, p75: 1050000, p90: 2300000, p95: 3750000, p99: 10300000 },
                    '65-74': { p10: 30000, p25: 150000, p50: 500000, p75: 1150000, p90: 2500000, p95: 4100000, p99: 11200000 },
                    '75+': { p10: 25000, p25: 120000, p50: 400000, p75: 920000, p90: 2000000, p95: 3300000, p99: 9000000 }
                },
                byIncome: {
                    '<30k': 0.30,
                    '30k-60k': 0.55,
                    '60k-120k': 1.0,
                    '120k-250k': 1.8,
                    '>250k': 3.2
                }
            }
        };
        
        function getAgeGroup(age) {
            if (age < 25) return '18-24';
            if (age < 35) return '25-34';
            if (age < 45) return '35-44';
            if (age < 55) return '45-54';
            if (age < 65) return '55-64';
            if (age < 75) return '65-74';
            return '75+';
        }
        
        function getIncomeMultiplier(region, income) {
            const brackets = peerDataByRegion[region]?.byIncome;
            if (!brackets) return 1.0;
            
            // Parse income brackets and find matching one
            const entries = Object.entries(brackets);
            for (const [bracket, multiplier] of entries) {
                const cleanBracket = bracket.replace(/[<>kKMm‚Ç¨$¬•]/g, '').replace(/,/g, '');
                const parts = cleanBracket.split('-');
                
                if (bracket.startsWith('<')) {
                    const max = parseFloat(parts[0]) * 1000;
                    if (income < max) return multiplier;
                } else if (bracket.startsWith('>')) {
                    const min = parseFloat(parts[0]) * 1000;
                    if (income >= min) return multiplier;
                } else if (parts.length === 2) {
                    const min = parseFloat(parts[0]) * 1000;
                    const max = parseFloat(parts[1]) * 1000;
                    if (income >= min && income < max) return multiplier;
                }
            }
            return 1.0;
        }
        
        function calculatePercentile(netWorth, ageData, incomeMultiplier = 1.0) {
            // Adjust thresholds by income multiplier
            const thresholds = [
                { p: 10, v: ageData.p10 * incomeMultiplier },
                { p: 25, v: ageData.p25 * incomeMultiplier },
                { p: 50, v: ageData.p50 * incomeMultiplier },
                { p: 75, v: ageData.p75 * incomeMultiplier },
                { p: 90, v: ageData.p90 * incomeMultiplier },
                { p: 95, v: ageData.p95 * incomeMultiplier },
                { p: 99, v: ageData.p99 * incomeMultiplier }
            ];
            
            // Linear interpolation between thresholds
            if (netWorth <= thresholds[0].v) {
                return Math.max(1, (netWorth / thresholds[0].v) * thresholds[0].p);
            }
            
            for (let i = 0; i < thresholds.length - 1; i++) {
                if (netWorth >= thresholds[i].v && netWorth < thresholds[i + 1].v) {
                    const range = thresholds[i + 1].v - thresholds[i].v;
                    const pctRange = thresholds[i + 1].p - thresholds[i].p;
                    const position = (netWorth - thresholds[i].v) / range;
                    return thresholds[i].p + (position * pctRange);
                }
            }
            
            // Above p99
            const lastThreshold = thresholds[thresholds.length - 1];
            if (netWorth >= lastThreshold.v) {
                // Logarithmic scale for top percentiles
                const excess = netWorth / lastThreshold.v;
                return Math.min(99.9, lastThreshold.p + Math.log10(excess) * 0.3);
            }
            
            return 50; // Default fallback
        }
        
        function updatePeerBenchmarkWidget(data) {
            const container = document.getElementById('peer-container');
            if (!container) return;
            
            // Calculate net worth from portfolio + other assets
            const portfolioNetWorth = (data.performance?.totalValue || 0) - Math.abs(data.loans?.borrowed || 0);
            const totalNetWorth = portfolioNetWorth + (peerConfig.otherAssets || 0);
            
            const region = peerConfig.region || 'US';
            const regionData = peerDataByRegion[region];
            const ageGroup = getAgeGroup(peerConfig.age || 47);
            const ageData = regionData?.byAge[ageGroup];
            
            if (!regionData || !ageData) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">Data not available</div>';
                return;
            }
            
            // Calculate income multiplier
            const incomeMultiplier = getIncomeMultiplier(region, peerConfig.income || 75000);
            
            // Calculate percentile using real interpolation
            const percentile = calculatePercentile(totalNetWorth, ageData, incomeMultiplier);
            
            // Calculate comparisons
            const adjustedMedian = ageData.p50 * incomeMultiplier;
            const adjustedP75 = ageData.p75 * incomeMultiplier;
            const adjustedP90 = ageData.p90 * incomeMultiplier;
            
            const vsMedian = ((totalNetWorth / adjustedMedian) * 100).toFixed(0);
            const vsP75 = ((totalNetWorth / adjustedP75) * 100).toFixed(0);
            const vsP90 = ((totalNetWorth / adjustedP90) * 100).toFixed(0);
            
            const getPercentileColor = (p) => {
                if (p >= 90) return 'var(--accent-green)';
                if (p >= 75) return 'var(--accent-blue)';
                if (p >= 50) return 'var(--accent-yellow)';
                return 'var(--accent-red)';
            };
            
            const getPercentileLabel = (p) => {
                if (p >= 95) return 'Top 5%';
                if (p >= 90) return 'Top 10%';
                if (p >= 75) return 'Top 25%';
                if (p >= 50) return 'Above Median';
                if (p >= 25) return 'Below Median';
                return 'Bottom 25%';
            };
            
            // Build HTML
            let html = '';
            
            // Main percentile display
            html += `<div style="text-align: center; margin-bottom: 12px;">
                <div style="font-size: 28px; font-weight: 700; color: ${getPercentileColor(percentile)};">${percentile.toFixed(1)}th</div>
                <div style="font-size: 13px; color: ${getPercentileColor(percentile)}; font-weight: 600; margin-top: 2px;">${getPercentileLabel(percentile)}</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${regionData.name} ‚Ä¢ Age ${peerConfig.age}</div>
            </div>`;
            
            // Comparison bars
            html += `<div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                    <span style="color: var(--text-secondary);">vs Median</span>
                    <span style="color: ${vsMedian >= 100 ? 'var(--accent-green)' : 'var(--accent-yellow)'}; font-weight: 600;">${vsMedian}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                    <span style="color: var(--text-secondary);">vs 75th</span>
                    <span style="color: ${vsP75 >= 100 ? 'var(--accent-green)' : 'var(--text-secondary)'}; font-weight: 600;">${vsP75}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                    <span style="color: var(--text-secondary);">vs 90th</span>
                    <span style="color: ${vsP90 >= 100 ? 'var(--accent-green)' : 'var(--text-secondary)'}; font-weight: 600;">${vsP90}%</span>
                </div>
            </div>`;
            
            // Reference values
            html += `<div style="font-size: 11px; color: var(--text-secondary); text-align: center; padding-top: 8px; border-top: 1px solid var(--border-color);">
                Median: ${formatCurrency(adjustedMedian, 0)} ‚Ä¢ 75th: ${formatCurrency(adjustedP75, 0)}
            </div>`;
            
            // Settings button
            html += `<div style="margin-top: 10px; text-align: center;">
                <button onclick="openPeerSettings()" style="font-size: 12px; padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                    ‚öôÔ∏è Settings
                </button>
            </div>`;
            
            // Source attribution
            html += `<div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-top: 8px;">
                Source: ${regionData.source}
            </div>`;
            
            container.innerHTML = html;
        }
        
        // Settings modal for peer configuration
        function openPeerSettings() {
            const modal = document.createElement('div');
            modal.id = 'peer-settings-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const regions = Object.keys(peerDataByRegion);
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 90%; border: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem;">Peer Benchmark Settings</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Your Age</label>
                            <input type="number" id="peer-age" value="${peerConfig.age}" min="18" max="100" 
                                style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Region / Country</label>
                            <select id="peer-region" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                                ${regions.map(r => `<option value="${r}" ${r === peerConfig.region ? 'selected' : ''}>${peerDataByRegion[r].name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Annual Household Income (USD)</label>
                            <input type="number" id="peer-income" value="${peerConfig.income}" min="0" step="5000"
                                style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 0.2rem;">Used to compare against peers at similar income levels</div>
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Other Assets (not in portfolio)</label>
                            <input type="number" id="peer-other-assets" value="${peerConfig.otherAssets}" min="0" step="10000"
                                style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 0.2rem;">House equity, retirement accounts, other investments, etc.</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button onclick="savePeerSettings()" style="flex: 1; padding: 0.6rem; background: var(--accent-blue); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                            Save
                        </button>
                        <button onclick="closePeerSettings()" style="flex: 1; padding: 0.6rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closePeerSettings();
            });
        }
        
        function savePeerSettings() {
            peerConfig.age = parseInt(document.getElementById('peer-age').value) || 47;
            peerConfig.region = document.getElementById('peer-region').value || 'US';
            peerConfig.income = parseInt(document.getElementById('peer-income').value) || 75000;
            peerConfig.otherAssets = parseInt(document.getElementById('peer-other-assets').value) || 0;
            
            localStorage.setItem('zhodler-peer-config', JSON.stringify(peerConfig));
            closePeerSettings();
            
            // Refresh the widget
            if (window.currentDashboardData) {
                updatePeerBenchmarkWidget(window.currentDashboardData);
            }
        }
        
        function closePeerSettings() {
            const modal = document.getElementById('peer-settings-modal');
            if (modal) modal.remove();
        }

        function updateGoals(goals) {
            const container = document.getElementById('goals-container');
            if (!container) return;
            
            console.log('Updating goals widget with:', goals);
            
            if (!goals || !Array.isArray(goals) || goals.length === 0) {
                container.innerHTML = `
                    <div style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                        <div>No goals data found</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">Check console (F12) for details</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = goals.map(goal => {
                // Handle the percent value - it might already be in 0-100 format or 0-1 format
                let percent = goal.percent || 0;
                // If percent is greater than 2, assume it's already in 0-100 format
                if (percent > 0 && percent <= 2) {
                    percent = percent * 100;
                }
                percent = Math.max(0, percent);
                
                // Debt goal is inverted (lower is better), show warning if over target
                const isDebtGoal = goal.description && goal.description.toLowerCase().includes('debt');
                const isWarning = isDebtGoal && percent > 100;
                
                // Calculate display width (cap at 100% for visual)
                const displayWidth = Math.min(100, percent);
                
                return `
                    <div class="goal-item">
                        <div class="goal-header">
                            <span class="goal-name">${goal.description || goal.name || 'Goal'}</span>
                            <span class="goal-percent">${percent.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isWarning ? 'warning' : ''}" style="width: ${displayWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLoanDetails(loans) {
            const container = document.getElementById('loan-details-container');
            if (!container) return;

            const getRiskClass = (ratio) => {
                if (ratio < 50) return 'safe';
                if (ratio < 70) return 'warning';
                return 'danger';
            };

            container.innerHTML = `
                <div class="loan-metric">
                    <span class="metric-label">Total Borrowed</span>
                    <span class="metric-value">${formatCurrency(loans.borrowed)}</span>
                </div>
                <div class="loan-metric">
                    <span class="metric-label">Collateral Value</span>
                    <span class="metric-value">${formatCurrency(loans.collateralValue)}</span>
                </div>
                <div class="loan-metric">
                    <span class="metric-label">Current LTV</span>
                    <span class="metric-value ${getRiskClass(loans.ratio)}">${formatPercent(loans.ratio / 100)}</span>
                </div>
                <div class="loan-metric">
                    <span class="metric-label">Max Safe Borrow</span>
                    <span class="metric-value">${formatCurrency(loans.maxSafeBorrow)}</span>
                </div>
                <div class="loan-metric">
                    <span class="metric-label">Liquidation Price</span>
                    <span class="metric-value danger">${formatCurrency(loans.liquidationPrice, 0)}</span>
                </div>
                <div class="loan-metric">
                    <span class="metric-label">Days to Pay Off</span>
                    <span class="metric-value">${loans.daysToPayOff || '--'} days</span>
                </div>
            `;
        }

        function updateFireSection(fire, timePassed) {
            const container = document.getElementById('fire-container');
            if (!container) return;
            
            if (!fire || !fire.scenarios || fire.scenarios.length === 0) {
                container.innerHTML = `
                    <div style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                        No FIRE data found
                    </div>
                `;
                return;
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '--';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return '--';
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            };
            
            const formatTime = (years, months, days) => {
                let parts = [];
                if (years && years > 0) parts.push(`${Math.floor(years)}y`);
                if (months && months > 0) parts.push(`${Math.floor(months)}m`);
                if (days && days > 0 && !years) parts.push(`${Math.floor(days)}d`);
                return parts.length > 0 ? parts.join(' ') : '--';
            };

            // Build scenarios HTML
            const scenariosHtml = fire.scenarios.map((scenario, index) => `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; ${index === 0 ? 'border-left: 3px solid var(--accent-green);' : 'border-left: 3px solid var(--accent-blue);'}">
                    <div style="font-weight: 600; font-size: 0.8rem; color: ${index === 0 ? 'var(--accent-green)' : 'var(--accent-blue)'}; margin-bottom: 0.5rem;">
                        ${scenario.label || 'Scenario ' + (index + 1)} ‚Äî ${formatCurrency(scenario.totalMonthly)}/mo
                    </div>
                    <div class="loan-metric" style="border: none; padding: 0.25rem 0;">
                        <span class="metric-label">Critical Mass</span>
                        <span class="metric-value">${formatCurrency(scenario.criticalMassValue)}</span>
                    </div>
                    <div class="loan-metric" style="border: none; padding: 0.25rem 0;">
                        <span class="metric-label">Time to FIRE</span>
                        <span class="metric-value ${index === 0 ? 'safe' : ''}">${formatTime(scenario.timeToFireYears, scenario.timeToFireMonths, scenario.timeToFireExtraDays)}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                ${scenariosHtml}
                <div class="loan-metric">
                    <span class="metric-label">Days Tracking</span>
                    <span class="metric-value">${timePassed?.daysPassed || '--'} days</span>
                </div>
            `;
        }

        // ============================================
        // Chart Updates
        // ============================================
        function updateCharts(data) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Use generated color palette
            const chartColors = colorPalette.length ? colorPalette : generatePalette(accentColor);
            const contrastColor = getContrastColor(accentColor);
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#a0a0a0';

            // Asset Allocation Chart
            const assetCtx = document.getElementById('chart-asset-allocation');
            if (assetCtx && data.assetDistro.length) {
                const filtered = data.assetDistro.filter(a => a.value > 100);
                const isMobile = window.innerWidth < 768;
                
                charts.assets = new Chart(assetCtx, {
                    type: 'doughnut',
                    data: {
                        labels: filtered.map(a => a.asset),
                        datasets: [{
                            data: filtered.map(a => a.value),
                            backgroundColor: chartColors.slice(0, 10),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: isMobile ? 'bottom' : 'right',
                                labels: { 
                                    color: textColor, 
                                    boxWidth: isMobile ? 8 : 12, 
                                    padding: isMobile ? 4 : 8, 
                                    font: { size: isMobile ? 9 : 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: $${value.toLocaleString()} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Projections Chart
            const projCtx = document.getElementById('chart-projections');
            if (projCtx && data.projections.length) {
                charts.projections = new Chart(projCtx, {
                    type: 'line',
                    data: {
                        labels: data.projections.map(p => 'W' + p.week),
                        datasets: [
                            {
                                label: 'Optimistic (Current APR)',
                                data: data.projections.map(p => p.projBal),
                                borderColor: chartColors[0],
                                backgroundColor: chartColors[0] + '20',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Conservative (All-time APR)',
                                data: data.projections.map(p => p.projBalAllTime),
                                borderColor: chartColors[2],
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: { 
                                    color: textColor, 
                                    callback: v => '$' + (v/1000).toFixed(0) + 'k',
                                    font: { size: window.innerWidth < 768 ? 9 : 11 }
                                },
                                grid: { color: textColor + '20' }
                            },
                            x: {
                                ticks: { 
                                    color: textColor,
                                    font: { size: window.innerWidth < 768 ? 9 : 11 }
                                },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { 
                                labels: { 
                                    color: textColor,
                                    boxWidth: window.innerWidth < 768 ? 8 : 12,
                                    font: { size: window.innerWidth < 768 ? 9 : 11 }
                                }
                            }
                        }
                    }
                });
            }

            // Yearly Performance Chart
            const yearlyCtx = document.getElementById('chart-yearly');
            console.log('Yearly performance data:', data.performance.yearly);
            
            if (yearlyCtx && data.performance.yearly && data.performance.yearly.length > 0) {
                const yearly = data.performance.yearly.filter(y => y.year && y.year !== 'total');
                console.log('Filtered yearly data for chart:', yearly);
                const isMobile = window.innerWidth < 768;
                
                if (yearly.length > 0) {
                    charts.yearly = new Chart(yearlyCtx, {
                        type: 'bar',
                        data: {
                            labels: yearly.map(y => y.year),
                            datasets: [
                                {
                                    label: 'Invested',
                                    data: yearly.map(y => y.invested),
                                    backgroundColor: chartColors[4] + '80',
                                    borderColor: chartColors[4],
                                    borderWidth: 1,
                                    yAxisID: 'y1',
                                    order: 4
                                },
                                {
                                    label: 'Portfolio',
                                    data: yearly.map(y => y.value),
                                    backgroundColor: chartColors[2] + '80',
                                    borderColor: chartColors[2],
                                    borderWidth: 1,
                                    yAxisID: 'y1',
                                    order: 3
                                },
                                {
                                    label: 'Profit',
                                    data: yearly.map(y => y.profit),
                                    backgroundColor: chartColors[0] + '80',
                                    borderColor: chartColors[0],
                                    borderWidth: 1,
                                    yAxisID: 'y1',
                                    order: 2
                                },
                                {
                                    label: 'Return %',
                                    data: yearly.map(y => y.percent),
                                    type: 'line',
                                    borderColor: chartColors[3],
                                    backgroundColor: chartColors[3],
                                    pointBackgroundColor: chartColors[3],
                                    pointRadius: isMobile ? 4 : 6,
                                    pointHoverRadius: isMobile ? 6 : 8,
                                    yAxisID: 'y',
                                    tension: 0.3,
                                    order: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Return %',
                                        color: textColor
                                    },
                                    ticks: { 
                                        color: chartColors[0], 
                                        callback: v => v.toFixed(0) + '%'
                                    },
                                    grid: { display: false }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Value ($)',
                                        color: textColor
                                    },
                                    ticks: { 
                                        color: textColor, 
                                        callback: v => '$' + (v/1000).toFixed(0) + 'k'
                                    },
                                    grid: { color: textColor + '20' }
                                },
                                x: {
                                    ticks: { color: textColor },
                                    grid: { display: false }
                                }
                            },
                            plugins: {
                                legend: { 
                                    labels: { 
                                        color: textColor,
                                        boxWidth: isMobile ? 8 : 12,
                                        padding: isMobile ? 4 : 10,
                                        font: { size: isMobile ? 9 : 11 }
                                    },
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.parsed.y;
                                            if (label.includes('%')) {
                                                return label + ': ' + value.toFixed(1) + '%';
                                            }
                                            return label + ': $' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.warn('No valid yearly data after filtering');
                }
            } else {
                console.warn('Yearly chart not rendered - missing data or canvas');
            }
            
            // Active vs Passive - Global (Horizontal Bar Chart)
            const activePassiveCtx = document.getElementById('chart-active-passive');
            
            if (activePassiveCtx && data.activePassiveGlobal) {
                const ap = data.activePassiveGlobal;
                console.log('Active/Passive chart data:', ap);
                
                const chartLabels = ['BTC collateral', 'volatiles', 'debt', 'balance', 'pooled stable'];
                const chartDataValues = [
                    ap.btcCollateral || 0,
                    ap.volatiles || 0,
                    ap.debt || 0,
                    ap.balance || 0,
                    ap.pooledStable || 0
                ];
                
                // Use generated palette colors
                const barColors = [
                    chartColors[0],  // BTC collateral
                    chartColors[1],  // volatiles
                    contrastColor,   // debt (negative - use contrast)
                    chartColors[3],  // balance
                    chartColors[2]   // pooled stable
                ];
                
                const isMobile = window.innerWidth < 768;
                
                charts.activePassive = new Chart(activePassiveCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartDataValues,
                            backgroundColor: barColors,
                            borderWidth: 0,
                            barThickness: isMobile ? 14 : 20
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { right: isMobile ? 55 : 75 }
                        },
                        scales: {
                            x: {
                                grid: { color: textColor + '15' },
                                ticks: { 
                                    color: textColor,
                                    font: { size: isMobile ? 11 : 12 },
                                    callback: function(value) {
                                        if (Math.abs(value) >= 1000) {
                                            return (value < 0 ? '-$' : '$') + (Math.abs(value)/1000).toFixed(0) + 'k';
                                        }
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { 
                                    color: textColor,
                                    font: { size: isMobile ? 11 : 13 }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.x;
                                        return '$' + value.toLocaleString(undefined, {maximumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'dataLabels',
                        afterDatasetsDraw: function(chart) {
                            const ctx = chart.ctx;
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => {
                                    const value = dataset.data[index];
                                    const formattedValue = value < 0 
                                        ? '-$' + Math.abs(value).toLocaleString(undefined, {maximumFractionDigits: 0})
                                        : '$' + value.toLocaleString(undefined, {maximumFractionDigits: 0});
                                    
                                    ctx.save();
                                    ctx.fillStyle = textColor;
                                    ctx.font = (isMobile ? '11px' : '13px') + " 'Inter', Arial, sans-serif";
                                    ctx.textAlign = value < 0 ? 'right' : 'left';
                                    ctx.textBaseline = 'middle';
                                    
                                    const x = value < 0 ? bar.x - 5 : bar.x + 5;
                                    ctx.fillText(formattedValue, x, bar.y);
                                    ctx.restore();
                                });
                            });
                        }
                    }]
                });
            } else {
                console.warn('Active/Passive chart not rendered. Canvas:', !!activePassiveCtx, 'Data:', !!data.activePassiveGlobal);
                if (!activePassiveCtx) {
                    console.warn('Canvas element "chart-active-passive" not found in DOM');
                }
                if (!data.activePassiveGlobal) {
                    console.warn('activePassiveGlobal data is missing');
                }
            }
        }

        // ============================================
        // Theme Management
        // ============================================
        function setTheme(theme) {
            document.body.className = theme !== 'default' ? `theme-${theme}` : '';
            localStorage.setItem('zhodler-theme', theme);
            if (portfolioData) {
                setTimeout(() => updateCharts(portfolioData), 100);
            }
        }

        // ============================================
        // Settings Management
        // ============================================
        function loadSettings() {
            const theme = localStorage.getItem('zhodler-theme') || 'default';
            document.getElementById('themeSelect').value = theme;
            setTheme(theme);

            // Default to user's sheet URL if not set
            const defaultUrl = 'https://docs.google.com/spreadsheets/d/19FOCRgYHY94QN3Jf7NaeMpGsEbQUdu9bKboYvy4fVpk/edit';
            const sheetsUrl = localStorage.getItem('zhodler-sheets-url') || defaultUrl;
            document.getElementById('sheetsUrl').value = sheetsUrl;
            
            // Save the default if not already set
            if (!localStorage.getItem('zhodler-sheets-url')) {
                localStorage.setItem('zhodler-sheets-url', defaultUrl);
            }
            
            const refreshInterval = localStorage.getItem('zhodler-refresh-interval') || '0';
            document.getElementById('refreshInterval').value = refreshInterval;
            setupAutoRefresh(parseInt(refreshInterval));

            // Load and sync accent color in settings modal
            const savedAccent = localStorage.getItem('zhodler-accent-color') || '#0ad5ec';
            document.getElementById('settingsAccentColor').value = savedAccent;
            updatePalettePreview(savedAccent);
        }

        function updatePalettePreview(color) {
            const palette = generatePalette(color);
            const preview = document.getElementById('palettePreview');
            if (preview) {
                preview.innerHTML = palette.slice(0, 6).map(c => 
                    `<div style="width: 20px; height: 20px; background: ${c}; border-radius: 3px;"></div>`
                ).join('');
            }
        }

        function saveSettings() {
            // Save data source settings
            const sheetsUrl = document.getElementById('sheetsUrl').value.trim();
            localStorage.setItem('zhodler-sheets-url', sheetsUrl);
            
            const refreshInterval = document.getElementById('refreshInterval').value;
            localStorage.setItem('zhodler-refresh-interval', refreshInterval);
            setupAutoRefresh(parseInt(refreshInterval));

            // Save and apply accent color
            const newAccent = document.getElementById('settingsAccentColor')?.value;
            if (newAccent) {
                onAccentColorChange(newAccent);
                document.getElementById('accentColorPicker').value = newAccent;
            }
            
            // Save peer settings
            const peerAge = document.getElementById('modal-peer-age');
            const peerRegion = document.getElementById('modal-peer-region');
            const peerIncome = document.getElementById('modal-peer-income');
            const peerOther = document.getElementById('modal-peer-other');
            
            if (peerAge) SettingsManager.set('peer.age', parseInt(peerAge.value) || 47);
            if (peerRegion) SettingsManager.set('peer.region', peerRegion.value || 'US');
            if (peerIncome) SettingsManager.set('peer.income', parseInt(peerIncome.value) || 75000);
            if (peerOther) SettingsManager.set('peer.otherAssets', parseInt(peerOther.value) || 0);
            
            // Save monte carlo settings
            const monteSims = document.getElementById('modal-monte-sims');
            const monteVol = document.getElementById('modal-monte-vol');
            const monteFire = document.getElementById('modal-monte-fire');
            const monteYears = document.getElementById('modal-monte-years');
            
            if (monteSims) SettingsManager.set('monteCarlo.simulations', parseInt(monteSims.value) || 1000);
            if (monteVol) SettingsManager.set('monteCarlo.volatility', parseInt(monteVol.value) || 10);
            if (monteFire) SettingsManager.set('monteCarlo.fireTarget', parseInt(monteFire.value) || 1000000);
            if (monteYears) SettingsManager.set('monteCarlo.yearsToProject', parseInt(monteYears.value) || 10);
            
            // Update legacy peerConfig for backward compatibility
            peerConfig = SettingsManager.current.peer;
            
            // Save to localStorage
            SettingsManager.saveToLocalStorage();
            
            // Close modal
            document.getElementById('settingsModal').classList.remove('active');
            
            // Refresh widgets with new settings
            if (window.currentDashboardData) {
                updatePeerBenchmarkWidget(window.currentDashboardData);
                updateMonteCarloWidget(window.currentDashboardData);
            }
            
            showToast('Settings saved locally!');
            
            // Load data with new URL
            if (sheetsUrl) {
                loadData();
            }
        }

        // ============================================
        // Status Bar
        // ============================================
        function showStatus(message, type = 'info') {
            const bar = document.getElementById('statusBar');
            bar.style.display = 'block';
            bar.style.opacity = '1';
            bar.style.background = type === 'error' ? '#c0392b' : type === 'success' ? '#1a5f2a' : '#2980b9';
            bar.textContent = message;
            bar.style.transition = 'opacity 0.5s ease';
            
            if (type === 'success') {
                setTimeout(() => {
                    bar.style.opacity = '0';
                    setTimeout(() => {
                        bar.style.display = 'none';
                    }, 500);
                }, 5000);
            }
        }
        
        // ============================================
        // Auto-refresh
        // ============================================
        let autoRefreshTimer = null;
        
        function setupAutoRefresh(intervalSeconds) {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            
            if (intervalSeconds > 0) {
                autoRefreshTimer = setInterval(() => {
                    console.log('Auto-refreshing data...');
                    loadData();
                }, intervalSeconds * 1000);
                console.log(`Auto-refresh set to ${intervalSeconds} seconds`);
            }
        }
        
        // ============================================
        // Main Data Loading Function
        // ============================================
        async function loadData() {
            const sheetsUrl = localStorage.getItem('zhodler-sheets-url');
            if (!sheetsUrl) {
                showStatus('‚öôÔ∏è Click Settings to enter your Google Sheets URL', 'info');
                return;
            }
            
            // Update UI to show loading state
            const refreshBtn = document.getElementById('refreshBtn');
            const originalBtnText = refreshBtn.textContent;
            refreshBtn.textContent = '‚è≥ Loading...';
            refreshBtn.disabled = true;
            
            // Clear any existing chart data to force fresh render
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                    delete charts[key];
                }
            });
            
            try {
                const fetchTime = new Date().toLocaleTimeString();
                showStatus(`üîÑ Fetching data at ${fetchTime}...`, 'info');
                console.log('='.repeat(50));
                console.log('DATA REFRESH STARTED:', new Date().toISOString());
                console.log('Sheet URL:', sheetsUrl);
                
                const sheets = await loadFromGoogleSheets(sheetsUrl);
                console.log('Loaded sheets:', Object.keys(sheets));
                
                // Log some sample data to verify freshness
                if (sheets['Performance'] && sheets['Performance'].length > 1) {
                    console.log('Sample Performance data (first 3 rows):');
                    sheets['Performance'].slice(0, 3).forEach((row, i) => console.log(`  Row ${i}:`, row));
                }
                
                const data = processData(sheets);
                console.log('Processed data summary:', {
                    totalValue: data.performance?.totalValue,
                    btcPrice: data.btcCrypto?.btcPrice,
                    loanBalance: data.loans?.balance
                });
                
                updateDashboard(data);
                
                // Update last updated timestamp with full precision
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                document.getElementById('lastUpdated').textContent = `Last updated: ${timeStr}`;
                
                const loadedCount = Object.keys(sheets).length;
                showStatus(`‚úÖ Loaded ${loadedCount} sheets at ${timeStr}. Note: Google Sheets may cache data for up to 5 min.`, 'success');
                console.log('DATA REFRESH COMPLETE:', new Date().toISOString());
                console.log('='.repeat(50));
            } catch (err) {
                console.error('Error loading data:', err);
                showStatus(`‚ùå ${err.message} ‚Äî Press F12 for details`, 'error');
            } finally {
                // Restore button state
                refreshBtn.textContent = originalBtnText;
                refreshBtn.disabled = false;
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initializing...');
            
            initDashboard();
            loadSettings();
            initLayoutLock();
            initColorPalette();
            
            // Initial data load
            setTimeout(loadData, 500);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadData);

            // Theme select
            document.getElementById('themeSelect').addEventListener('change', (e) => {
                setTheme(e.target.value);
            });

            // Accent color picker
            document.getElementById('accentColorPicker').addEventListener('input', (e) => {
                onAccentColorChange(e.target.value);
            });

            // Reset layout
            document.getElementById('resetLayoutBtn').addEventListener('click', resetLayout);

            // Lock/Unlock layout
            document.getElementById('lockLayoutBtn').addEventListener('click', toggleLayoutLock);

            // Privacy toggle
            document.getElementById('privacyToggle').addEventListener('click', () => {
                document.body.classList.toggle('privacy-mode');
                const toggle = document.getElementById('privacyToggle');
                toggle.classList.toggle('active');
                if (document.body.classList.contains('privacy-mode')) {
                    toggle.textContent = 'üîì Show';
                } else {
                    toggle.textContent = 'üîí Privacy';
                }
            });

            // Settings modal
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('active');
                // Sync accent color picker in settings with current color
                document.getElementById('settingsAccentColor').value = accentColor;
                updatePalettePreview(accentColor);
                
                // Populate all settings inputs
                populateModalInputs();
                
                // Reset to Data tab
                switchModalTab('data');
            });
            
            // Settings accent color picker - live preview
            document.getElementById('settingsAccentColor').addEventListener('input', (e) => {
                updatePalettePreview(e.target.value);
            });
            
            // Test connection button
            document.getElementById('testConnectionBtn').addEventListener('click', async () => {
                const resultDiv = document.getElementById('testResult');
                const urlInput = document.getElementById('sheetsUrl');
                const url = urlInput.value.trim();
                
                if (!url) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#c0392b';
                    resultDiv.textContent = '‚ùå Please enter a URL first';
                    return;
                }
                
                const sheetId = extractSheetId(url);
                if (!sheetId) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#c0392b';
                    resultDiv.textContent = '‚ùå Invalid Google Sheets URL';
                    return;
                }
                
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#2980b9';
                resultDiv.textContent = 'üîÑ Testing connection...';
                
                try {
                    const testSheet = await fetchSheetAsCSV(sheetId, 'Performance');
                    resultDiv.style.background = '#1a5f2a';
                    resultDiv.textContent = `‚úÖ Success! Found ${testSheet.length} rows in Performance sheet`;
                } catch (err) {
                    resultDiv.style.background = '#c0392b';
                    resultDiv.innerHTML = `‚ùå Connection failed: ${err.message}<br><small>Make sure the sheet is published to the web</small>`;
                }
            });

            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('active');
            });

            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

            // Export layout button
            document.getElementById('exportLayoutBtn').addEventListener('click', exportLayout);
            
            // Import layout button - trigger file picker
            document.getElementById('importLayoutBtn').addEventListener('click', () => {
                document.getElementById('importLayoutFile').click();
            });
            
            // Handle file selection for import
            document.getElementById('importLayoutFile').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importLayout(e.target.files[0]);
                    e.target.value = ''; // Reset for future imports
                }
            });

            // Close modal on overlay click
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') {
                    document.getElementById('settingsModal').classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
